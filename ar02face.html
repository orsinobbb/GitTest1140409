<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>iPhone16 Pro Camera WebGL</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { margin:0; overflow:hidden; background:black; }
  #debug { 
    position:fixed; top:0; left:0; padding:8px;
    background:rgba(0,0,0,0.5); color:#0f0; font-size:14px;
  }
</style>
</head>

<body>
<div id="debug">初始化中…</div>
<canvas id="glcanvas"></canvas>

<script>
const debug = msg => document.getElementById("debug").innerText = msg;
const canvas = document.getElementById("glcanvas");
const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.onresize = resize;

// ------ WebGL shader ------
const vs = `
attribute vec2 aPos;
attribute vec2 aTex;
varying vec2 vTex;
void main(){
  gl_Position = vec4(aPos, 0.0, 1.0);
  vTex = aTex;
}`;
const fs = `
precision mediump float;
varying vec2 vTex;
uniform sampler2D uTex;
void main(){
  gl_FragColor = texture2D(uTex, vTex);
}`;

function createShader(type, src){
  let s = gl.createShader(type);
  gl.shaderSource(s, src);
  gl.compileShader(s);
  return s;
}
function createProgram(vsSrc, fsSrc){
  let p = gl.createProgram();
  gl.attachShader(p, createShader(gl.VERTEX_SHADER, vsSrc));
  gl.attachShader(p, createShader(gl.FRAGMENT_SHADER, fsSrc));
  gl.linkProgram(p);
  return p;
}

const program = createProgram(vs, fs);
gl.useProgram(program);

// full screen quad
const verts = new Float32Array([
  -1, -1,   0, 0,
   1, -1,   1, 0,
  -1,  1,   0, 1,
   1,  1,   1, 1,
]);
const buf = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, buf);
gl.bufferData(gl.ARRAY_BUFFER, verts, gl.STATIC_DRAW);

const aPos = gl.getAttribLocation(program, "aPos");
const aTex = gl.getAttribLocation(program, "aTex");
gl.enableVertexAttribArray(aPos);
gl.enableVertexAttribArray(aTex);
gl.vertexAttribPointer(aPos, 2, gl.FLOAT, false, 16, 0);
gl.vertexAttribPointer(aTex, 2, gl.FLOAT, false, 16, 8);

// texture
const tex = gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D, tex);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

(async function(){
  debug("請允許相機…");

  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"user" },
    audio:false
  });

  const video = document.createElement("video");
  video.srcObject = stream;
  video.playsinline = true;
  await video.play();

  debug("相機開啟成功（WebGL 模式）");

  function draw(){
    gl.bindTexture(gl.TEXTURE_2D, tex);
    gl.texImage2D(
      gl.TEXTURE_2D, 0, gl.RGB,
      gl.RGB, gl.UNSIGNED_BYTE, video
    );

    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
    requestAnimationFrame(draw);
  }
  draw();
})();
</script>
</body>
</html>