<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Face AR + 年齡性別估計 (iPhone16 Pro)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #debug {
      position: fixed;
      top: 0;
      left: 0;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.5);
      color: #00ff00;
      font-size: 14px;
      z-index: 20;
    }
    #videoWrap {
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 0;
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* 自拍鏡像 */
    }
    #overlay {
      position: fixed;
      inset: 0;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="debug">初始化中…</div>

  <!-- 直接顯示前鏡頭畫面 -->
  <div id="videoWrap">
    <video id="video" playsinline autoplay muted></video>
  </div>

  <!-- 在上面畫臉部線條 + 年齡性別框 -->
  <canvas id="overlay"></canvas>

  <!-- Human：TF.js 多模型 (含 Age/Gender)，使用 IIFE 版本 -->
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/human/dist/human.js"></script>

  <!-- MediaPipe Tasks for Web + 我們的主程式 -->
  <script type="module">
    import {
      FaceLandmarker,
      FilesetResolver,
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.15/vision_bundle.mjs";

    const debug = (msg) => (document.getElementById("debug").innerText = msg);

    const video = document.getElementById("video");
    const overlay = document.getElementById("overlay");
    const ctx = overlay.getContext("2d");

    function resizeCanvas() {
      overlay.width = window.innerWidth;
      overlay.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          facingMode: "user",
          width: { ideal: 1280 },
          height: { ideal: 720 },
        },
      });
      video.srcObject = stream;

      return new Promise((resolve) => {
        video.onloadedmetadata = () => {
          video.play();
          resizeCanvas();
          resolve();
        };
      });
    }

    let faceLandmarker;
    let running = false;

    // ====== Human：年齡 / 性別 推論 ======
    // human 套件會掛在 window.Human 上
    const humanConfig = {
      backend: 'webgl',
      modelBasePath: 'https://cdn.jsdelivr.net/npm/@vladmandic/human/models',
      // 只開啟我們需要的功能，避免太慢
      face: { enabled: true, mesh: false, iris: false },
      body: { enabled: false },
      hand: { enabled: false },
      object: { enabled: false },
      segmentation: { enabled: false },
      gesture: { enabled: false },
      // 這三個是關鍵
      age: { enabled: true },
      gender: { enabled: true },
      emotion: { enabled: false },
    };

    const human = new Human.Human(humanConfig);

    let lastAgeGenderText = "";
    let lastHumanTime = 0; // ms

    async function updateAgeGender(nowMs) {
      // 每 0.8 秒算一次，減少負擔
      if (nowMs - lastHumanTime < 800) return;
      lastHumanTime = nowMs;

      try {
        const result = await human.detect(video);
        if (result.face && result.face.length > 0) {
          const f = result.face[0];

          const age = f.age;  // 數值 (約 0~100)
          const genderInfo = (f.gender && f.gender.length > 0) ? f.gender[0] : null;

          if (age && genderInfo) {
            const ageRound = Math.round(age);
            const genderLabel = genderInfo.label;      // 'male' / 'female'
            const genderScore = genderInfo.score || 0; // 0~1 信心度

            let genderZh = genderLabel === 'male' ? '男性' :
                           genderLabel === 'female' ? '女性' : '未知';

            lastAgeGenderText = `約 ${ageRound} 歲 · ${genderZh} (${Math.round(genderScore * 100)}%)`;
          } else {
            lastAgeGenderText = "";
          }
        } else {
          lastAgeGenderText = "";
        }
      } catch (e) {
        console.error("Human detect error:", e);
      }
    }

    // ====== MediaPipe 人臉 Landmark 繪圖 ======
    function drawFaceLandmarks(result) {
      ctx.clearRect(0, 0, overlay.width, overlay.height);

      if (!result.faceLandmarks || !result.faceLandmarks[0]) {
        debug("相機正常，找不到臉，請把臉靠近一點");
        return;
      }

      debug("✔ 已偵測到臉（含年齡 / 性別估計）");

      const landmarks = result.faceLandmarks[0];

      const leftEye = landmarks[33];
      const rightEye = landmarks[263];

      const x1 = leftEye.x * overlay.width;
      const y1 = leftEye.y * overlay.height;
      const x2 = rightEye.x * overlay.width;
      const y2 = rightEye.y * overlay.height;

      // 綠線：兩眼連線
      ctx.strokeStyle = "#00ff00";
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();

      // 年齡 / 性別小框框
      if (lastAgeGenderText) {
        ctx.font = "18px -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        const textWidth = ctx.measureText(lastAgeGenderText).width;
        const cx = (x1 + x2) / 2;
        const cy = Math.min(y1, y2) - 30;  // 額頭上方一點點

        const paddingX = 8;
        const paddingY = 6;

        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
        ctx.fillRect(
          cx - textWidth / 2 - paddingX,
          cy - 18 - paddingY,
          textWidth + paddingX * 2,
          18 + paddingY * 2
        );

        ctx.fillStyle = "#00ff00";
        ctx.fillText(lastAgeGenderText, cx - textWidth / 2, cy);
      }
    }

    async function setupFaceLandmarker() {
      debug("相機正常，載入人臉模型…");

      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.15/wasm"
      );

      faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath:
            "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
        },
        runningMode: "VIDEO",
        numFaces: 1,
      });

      debug("人臉模型載入完成 ✔，載入年齡 / 性別模型中…");

      // Human 模型載入
      await human.load();

      debug("全部模型載入完成 ✔");
    }

    async function startLoop() {
      if (!faceLandmarker) return;
      running = true;

      const loop = () => {
        if (!running) return;

        const nowMs = performance.now();
        const result = faceLandmarker.detectForVideo(video, nowMs);
        if (result) {
          drawFaceLandmarks(result);
          // 年齡 / 性別更新（非同步、低頻率）
          updateAgeGender(nowMs);
        }

        requestAnimationFrame(loop);
      };
      loop();
    }

    (async () => {
      try {
        debug("請允許使用相機…");
        await setupCamera();
        await setupFaceLandmarker();
        await startLoop();
      } catch (err) {
        console.error(err);
        debug("❌ 發生錯誤：" + err);
      }
    })();
  </script>
</body>
</html>