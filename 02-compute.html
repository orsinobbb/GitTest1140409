<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>02. è¨ˆç®—é‚Šç•Œæ¸¬è©¦</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
  <div class="container">
    <div class="nav-links">
      <a href="index.html">â† å›é¦–é </a>
      <a href="01-basic.html">â† ä¸Šä¸€å€‹</a>
      <a href="03-worker.html">ä¸‹ä¸€å€‹ â†’</a>
    </div>

    <h1>02. è¨ˆç®—é‚Šç•Œæ¸¬è©¦</h1>
    <p class="subtitle">Numpy çŸ©é™£é‹ç®—ã€è¨˜æ†¶é«”é™åˆ¶ã€UI é˜»å¡è§€å¯Ÿ</p>

    <div class="warning">
      <strong>âš ï¸ é«˜è² è¼‰æ¸¬è©¦è­¦å‘Š</strong>
      <ul style="margin-top: 10px; margin-left: 20px;">
        <li>N > 2000 å¯èƒ½å°è‡´ç€è¦½å™¨ç„¡å›æ‡‰æˆ–ç•¶æ©Ÿ</li>
        <li>å»ºè­°å¾ N=800 é–‹å§‹æ¸¬è©¦</li>
        <li>æ¸¬è©¦æœŸé–“æœƒçœ‹åˆ° UI å¿ƒè·³åœæ­¢ï¼ˆé€™æ˜¯æ­£å¸¸ç¾è±¡ï¼‰</li>
        <li>è¨˜æ†¶é«”ä¸è¶³æ™‚æœƒæ‹‹å‡º MemoryError</li>
      </ul>
    </div>

    <!-- UI å¿ƒè·³ç›£æ¸¬ -->
    <div class="card">
      <h3>UI å¿ƒè·³ç›£æ¸¬ï¼ˆè§€å¯Ÿæ˜¯å¦é˜»å¡ï¼‰</h3>
      <div class="row">
        <div class="metric">
          <div class="metric-value" id="heartbeat">0</div>
          <div class="metric-label">å¿ƒè·³è¨ˆæ•¸ï¼ˆæ¯50msï¼‰</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="fps">60</div>
          <div class="metric-label">FPSï¼ˆæµæš¢åº¦ï¼‰</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="heartbeat-bar" style="width: 0%"></div>
      </div>
      <p style="color: #666; margin-top: 10px;">
        ğŸ’¡ ç•¶è¨ˆç®—é–‹å§‹æ™‚ï¼Œè§€å¯Ÿå¿ƒè·³è¨ˆæ•¸æ˜¯å¦åœæ­¢ â†’ é€™å°±æ˜¯ã€Œä¸»åŸ·è¡Œç·’é˜»å¡ã€
      </p>
    </div>

    <!-- æ¸¬è©¦æ§åˆ¶ -->
    <div class="card">
      <h3>æ¸¬è©¦æ§åˆ¶å°</h3>
      <div class="row">
        <label>çŸ©é™£å¤§å° N:</label>
        <select id="matrix-size">
          <option value="500">500 (å®‰å…¨)</option>
          <option value="800" selected>800 (å»ºè­°èµ·é»)</option>
          <option value="1000">1000 (ä¸­ç­‰)</option>
          <option value="1200">1200 (åé‡)</option>
          <option value="1600">1600 (å¾ˆé‡)</option>
          <option value="2000">2000 (å±éšª)</option>
          <option value="2400">2400 (æ¥µé™)</option>
        </select>
        <input type="number" id="custom-size" placeholder="è‡ªè¨‚å¤§å°" min="100" max="5000" style="width: 120px;">
      </div>
      <div class="row">
        <button id="btn-single">å–®æ¬¡é‹ç®—</button>
        <button id="btn-stress">å£“åŠ›æ¸¬è©¦ (5æ¬¡)</button>
        <button id="btn-progressive">æ¼¸é€²æ¸¬è©¦ (500â†’2000)</button>
        <button id="btn-memory">è¨˜æ†¶é«”æ¥µé™æ¸¬è©¦</button>
      </div>
      <div class="row">
        <button id="btn-clear" class="secondary">æ¸…ç©ºè¼¸å‡º</button>
        <button id="btn-stop" class="danger" disabled>å¼·åˆ¶åœæ­¢ (åƒ…ä¾›åƒè€ƒ)</button>
      </div>
    </div>

    <!-- å³æ™‚ç‹€æ…‹ -->
    <div class="card">
      <h3>å³æ™‚ç‹€æ…‹</h3>
      <div class="grid">
        <div class="metric">
          <div class="metric-value" id="current-status">å¾…å‘½</div>
          <div class="metric-label">ç•¶å‰ç‹€æ…‹</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="run-count">0</div>
          <div class="metric-label">å®Œæˆæ¬¡æ•¸</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="total-time">0.00</div>
          <div class="metric-label">ç´¯è¨ˆæ™‚é–“ (ç§’)</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="mem-usage">--</div>
          <div class="metric-label">é ä¼°è¨˜æ†¶é«” (MB)</div>
        </div>
      </div>
    </div>

    <!-- æ•ˆèƒ½åœ–è¡¨ -->
    <div class="card">
      <h3>æ•ˆèƒ½åŸºæº–åœ–è¡¨</h3>
      <canvas id="perf-chart" width="800" height="300"></canvas>
      <p style="color: #666; margin-top: 10px;">
        è¨˜éŒ„æ¯æ¬¡é‹ç®—çš„æ™‚é–“ï¼Œè§€å¯Ÿæ•ˆèƒ½è¶¨å‹¢
      </p>
    </div>

    <!-- è©³ç´°è¼¸å‡º -->
    <div class="card">
      <h3>è©³ç´°è¼¸å‡ºæ—¥èªŒ</h3>
      <div class="output-box" id="output" style="max-height: 500px;"></div>
    </div>

    <!-- é‚Šç•Œåˆ†æ -->
    <div class="card">
      <h3>ğŸ“Š é‚Šç•Œåˆ†æå ±å‘Š</h3>
      <div id="analysis" class="info" style="display: none;">
        <h4>æ¸¬è©¦ç¸½çµ</h4>
        <div id="analysis-content"></div>
      </div>
    </div>

  </div>

  <!-- PyScript é…ç½® -->
  <py-config>
    packages = ["numpy"]
  </py-config>

  <!-- PyScript ç¨‹å¼ç¢¼ -->
  <py-script>
from pyscript import document, window
import time

# å…¨åŸŸè®Šæ•¸
output = document.querySelector("#output")
run_count = 0
total_time = 0.0
perf_history = []

def log(msg, level="info"):
    """è¼¸å‡ºæ—¥èªŒ"""
    timestamp = time.strftime("%H:%M:%S")
    prefix = {
        "info": "â„¹ï¸",
        "success": "âœ…",
        "warning": "âš ï¸",
        "error": "âŒ",
        "compute": "ğŸ”¢"
    }.get(level, "â„¹ï¸")
    
    output.innerText += f"[{timestamp}] {prefix} {msg}\n"
    output.scrollTop = output.scrollHeight

def update_status(status, mem_mb=None):
    """æ›´æ–°ç‹€æ…‹é¡¯ç¤º"""
    document.querySelector("#current-status").innerText = status
    if mem_mb:
        document.querySelector("#mem-usage").innerText = f"{mem_mb:.1f}"

def matmul_benchmark(n):
    """åŸ·è¡ŒçŸ©é™£ä¹˜æ³•åŸºæº–æ¸¬è©¦"""
    import numpy as np
    
    log(f"é–‹å§‹è¨ˆç®— {n}Ã—{n} çŸ©é™£ä¹˜æ³•...", "compute")
    update_status(f"è¨ˆç®—ä¸­ (N={n})")
    
    # ä¼°ç®—è¨˜æ†¶é«”ï¼ˆ3å€‹çŸ©é™£ï¼ša, b, cï¼‰
    mem_mb = (3 * n * n * 4) / (1024 ** 2)
    update_status(f"è¨ˆç®—ä¸­ (N={n})", mem_mb)
    
    try:
        # ç”Ÿæˆéš¨æ©ŸçŸ©é™£
        t0 = time.perf_counter()
        a = np.random.rand(n, n).astype(np.float32)
        b = np.random.rand(n, n).astype(np.float32)
        gen_time = time.perf_counter() - t0
        
        # çŸ©é™£ä¹˜æ³•
        t1 = time.perf_counter()
        c = a @ b
        compute_time = time.perf_counter() - t1
        
        # è¨ˆç®— checksumï¼ˆé¿å…è¢«å„ªåŒ–æ‰ï¼‰
        checksum = float(c[0, 0] + c[-1, -1])
        
        total = gen_time + compute_time
        
        log(f"å®Œæˆ N={n}", "success")
        log(f"  ç”Ÿæˆæ™‚é–“: {gen_time:.3f}s", "info")
        log(f"  è¨ˆç®—æ™‚é–“: {compute_time:.3f}s", "info")
        log(f"  ç¸½æ™‚é–“: {total:.3f}s", "info")
        log(f"  è¨˜æ†¶é«”: ~{mem_mb:.1f} MB", "info")
        log(f"  Checksum: {checksum:.6f}", "info")
        log("-" * 50, "info")
        
        return {
            "n": n,
            "time": total,
            "mem": mem_mb,
            "success": True
        }
        
    except MemoryError:
        log(f"è¨˜æ†¶é«”ä¸è¶³ï¼N={n} è¶…éç€è¦½å™¨è¨˜æ†¶é«”é™åˆ¶", "error")
        log("é€™æ˜¯ PyScript åœ¨ç€è¦½å™¨ä¸­çš„å¯¦éš›é‚Šç•Œ", "warning")
        return {
            "n": n,
            "time": 0,
            "mem": mem_mb,
            "success": False,
            "error": "MemoryError"
        }
    except Exception as e:
        log(f"éŒ¯èª¤: {type(e).__name__}: {e}", "error")
        return {
            "n": n,
            "time": 0,
            "mem": mem_mb,
            "success": False,
            "error": str(e)
        }

def update_chart():
    """æ›´æ–°æ•ˆèƒ½åœ–è¡¨ï¼ˆå‘¼å« JSï¼‰"""
    if perf_history:
        window.updatePerfChart(perf_history)

def update_counters():
    """æ›´æ–°è¨ˆæ•¸å™¨"""
    global run_count, total_time
    document.querySelector("#run-count").innerText = str(run_count)
    document.querySelector("#total-time").innerText = f"{total_time:.2f}"

# ===== æ¸¬è©¦å‡½æ•¸ =====

def single_run(*args):
    """å–®æ¬¡é‹ç®—"""
    global run_count, total_time
    
    size = document.querySelector("#matrix-size").value
    custom = document.querySelector("#custom-size").value
    n = int(custom) if custom else int(size)
    
    log(f"=== å–®æ¬¡æ¸¬è©¦ N={n} ===", "info")
    result = matmul_benchmark(n)
    
    if result["success"]:
        run_count += 1
        total_time += result["time"]
        perf_history.append(result)
        update_chart()
    
    update_counters()
    update_status("å¾…å‘½")

def stress_test(*args):
    """å£“åŠ›æ¸¬è©¦ï¼ˆé€£çºŒ5æ¬¡ï¼‰"""
    global run_count, total_time
    
    size = document.querySelector("#matrix-size").value
    n = int(size)
    
    log(f"=== å£“åŠ›æ¸¬è©¦é–‹å§‹ (N={n}, 5æ¬¡) ===", "warning")
    
    for i in range(5):
        log(f"--- ç¬¬ {i+1}/5 è¼ª ---", "info")
        result = matmul_benchmark(n)
        
        if not result["success"]:
            log("å£“åŠ›æ¸¬è©¦ä¸­æ–·ï¼ˆè¨˜æ†¶é«”ä¸è¶³ï¼‰", "error")
            break
        
        run_count += 1
        total_time += result["time"]
        perf_history.append(result)
    
    update_chart()
    update_counters()
    update_status("å¾…å‘½")
    log("=== å£“åŠ›æ¸¬è©¦å®Œæˆ ===", "success")

def progressive_test(*args):
    """æ¼¸é€²æ¸¬è©¦ï¼ˆ500 â†’ 2000ï¼‰"""
    global run_count, total_time
    
    sizes = [500, 800, 1000, 1200, 1600, 2000]
    log("=== æ¼¸é€²æ¸¬è©¦é–‹å§‹ ===", "warning")
    log(f"æ¸¬è©¦åºåˆ—: {sizes}", "info")
    
    for n in sizes:
        log(f"--- æ¸¬è©¦ N={n} ---", "info")
        result = matmul_benchmark(n)
        
        if not result["success"]:
            log(f"æ¼¸é€²æ¸¬è©¦åœ¨ N={n} è™•ä¸­æ–·", "error")
            break
        
        run_count += 1
        total_time += result["time"]
        perf_history.append(result)
        update_chart()
    
    update_counters()
    update_status("å¾…å‘½")
    log("=== æ¼¸é€²æ¸¬è©¦å®Œæˆ ===", "success")
    
    # ç”Ÿæˆåˆ†æå ±å‘Š
    generate_analysis()

def memory_limit_test(*args):
    """è¨˜æ†¶é«”æ¥µé™æ¸¬è©¦ï¼ˆäºŒåˆ†æ³•å°‹æ‰¾æ¥µé™ï¼‰"""
    global run_count, total_time
    
    log("=== è¨˜æ†¶é«”æ¥µé™æ¸¬è©¦é–‹å§‹ ===", "warning")
    log("ä½¿ç”¨äºŒåˆ†æ³•å°‹æ‰¾è¨˜æ†¶é«”é‚Šç•Œ...", "info")
    
    low = 1000
    high = 5000
    last_success = low
    
    while low <= high:
        mid = (low + high) // 2
        log(f"å˜—è©¦ N={mid}...", "info")
        
        result = matmul_benchmark(mid)
        
        if result["success"]:
            last_success = mid
            run_count += 1
            total_time += result["time"]
            perf_history.append(result)
            update_chart()
            low = mid + 200
        else:
            high = mid - 200
    
    update_counters()
    update_status("å¾…å‘½")
    log(f"=== è¨˜æ†¶é«”æ¥µé™æ¸¬è©¦å®Œæˆ ===", "success")
    log(f"æœ€å¤§å¯é‹ç®—çŸ©é™£: N={last_success}", "success")
    log(f"å°æ‡‰è¨˜æ†¶é«”: ~{(3 * last_success * last_success * 4) / (1024**2):.1f} MB", "info")

def clear_output(*args):
    """æ¸…ç©ºè¼¸å‡º"""
    output.innerText = ""
    log("è¼¸å‡ºå·²æ¸…ç©º", "info")

def generate_analysis():
    """ç”Ÿæˆåˆ†æå ±å‘Š"""
    if not perf_history:
        return
    
    analysis_div = document.querySelector("#analysis")
    analysis_content = document.querySelector("#analysis-content")
    
    # è¨ˆç®—çµ±è¨ˆè³‡æ–™
    times = [r["time"] for r in perf_history if r["success"]]
    sizes = [r["n"] for r in perf_history if r["success"]]
    
    if not times:
        return
    
    avg_time = sum(times) / len(times)
    max_time = max(times)
    min_time = min(times)
    max_n = max(sizes)
    
    # è¨ˆç®—æ™‚é–“è¤‡é›œåº¦ï¼ˆç†è«–ä¸Šæ˜¯ O(n^3)ï¼‰
    if len(times) >= 2:
        # ç°¡å–®çš„è¤‡é›œåº¦ä¼°ç®—
        ratio = times[-1] / times[0] if times[0] > 0 else 0
        n_ratio = sizes[-1] / sizes[0] if sizes[0] > 0 else 0
        
        report = f"""
<ul style="margin-left: 20px;">
  <li><strong>æ¸¬è©¦æ¬¡æ•¸:</strong> {len(times)} æ¬¡</li>
  <li><strong>å¹³å‡æ™‚é–“:</strong> {avg_time:.3f} ç§’</li>
  <li><strong>æœ€å¿«æ™‚é–“:</strong> {min_time:.3f} ç§’ (N={sizes[times.index(min_time)]})</li>
  <li><strong>æœ€æ…¢æ™‚é–“:</strong> {max_time:.3f} ç§’ (N={sizes[times.index(max_time)]})</li>
  <li><strong>æœ€å¤§æˆåŠŸçŸ©é™£:</strong> N={max_n}</li>
  <li><strong>æ™‚é–“æˆé•·ç‡:</strong> {ratio:.2f}x (çŸ©é™£å¤§å° {n_ratio:.2f}x)</li>
  <li><strong>è¤‡é›œåº¦ä¼°ç®—:</strong> æ¥è¿‘ O(n^{2.7 if ratio < n_ratio**2.5 else 3})</li>
</ul>

<h4 style="margin-top: 15px;">é—œéµç™¼ç¾</h4>
<ul style="margin-left: 20px;">
  <li>{'âš ï¸ æ™‚é–“æˆé•·éç·šæ€§ï¼šçŸ©é™£ç¿»å€ï¼Œæ™‚é–“å¢é•·ç´„ ' + f'{ratio/(n_ratio**2):.1f}' + '~8å€' if ratio > 4 else 'âœ… æ•ˆèƒ½å°šå¯æ¥å—'}</li>
  <li>{'âš ï¸ è¨˜æ†¶é«”æ˜¯ä¸»è¦é™åˆ¶ï¼šN > 2000 å®¹æ˜“å¤±æ•—' if max_n > 1500 else 'âœ… åœ¨å®‰å…¨ç¯„åœå…§'}</li>
  <li>ğŸ” ä¸»åŸ·è¡Œç·’é˜»å¡ï¼šæ‰€æœ‰æ¸¬è©¦æœŸé–“ UI éƒ½æœƒå¡ä½</li>
</ul>
        """
        
        analysis_content.innerHTML = report
        analysis_div.style.display = "block"

# ç¶å®šäº‹ä»¶
document.querySelector("#btn-single").addEventListener("click", single_run)
document.querySelector("#btn-stress").addEventListener("click", stress_test)
document.querySelector("#btn-progressive").addEventListener("click", progressive_test)
document.querySelector("#btn-memory").addEventListener("click", memory_limit_test)
document.querySelector("#btn-clear").addEventListener("click", clear_output)

# åˆå§‹åŒ–
log("ğŸ è¨ˆç®—é‚Šç•Œæ¸¬è©¦æ¨¡çµ„å·²è¼‰å…¥", "success")
log("æº–å‚™é€²è¡Œé«˜è² è¼‰è¨ˆç®—æ¸¬è©¦", "info")
update_status("å¾…å‘½")
  </py-script>

  <!-- JavaScript è¼”åŠ© -->
  <script>
    // UI å¿ƒè·³ç›£æ¸¬
    let heartbeat = 0;
    let lastTime = performance.now();
    let fps = 60;

    function updateHeartbeat() {
      heartbeat++;
      document.getElementById("heartbeat").textContent = heartbeat;
      document.getElementById("heartbeat-bar").style.width = (heartbeat % 100) + "%";
      
      // è¨ˆç®— FPS
      const now = performance.now();
      fps = Math.round(1000 / (now - lastTime));
      lastTime = now;
      document.getElementById("fps").textContent = fps;
    }

    setInterval(updateHeartbeat, 50);

    // æ•ˆèƒ½åœ–è¡¨ï¼ˆä½¿ç”¨ Canvasï¼‰
    const canvas = document.getElementById("perf-chart");
    const ctx = canvas.getContext("2d");

    window.updatePerfChart = function(data) {
      const width = canvas.width;
      const height = canvas.height;
      const padding = 40;
      
      // æ¸…ç©ºç•«å¸ƒ
      ctx.fillStyle = "#fafafa";
      ctx.fillRect(0, 0, width, height);
      
      if (data.length === 0) return;
      
      // æ‰¾å‡ºæœ€å¤§å€¼
      const maxTime = Math.max(...data.map(d => d.time));
      const maxN = Math.max(...data.map(d => d.n));
      
      // ç¹ªè£½åº§æ¨™è»¸
      ctx.strokeStyle = "#999";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();
      
      // ç¹ªè£½æ¨™ç±¤
      ctx.fillStyle = "#666";
      ctx.font = "12px sans-serif";
      ctx.fillText("æ™‚é–“ (ç§’)", 10, 20);
      ctx.fillText("çŸ©é™£å¤§å° N", width - 80, height - 10);
      
      // ç¹ªè£½æ•¸æ“šé»å’Œé€£ç·š
      ctx.strokeStyle = "#667eea";
      ctx.fillStyle = "#667eea";
      ctx.lineWidth = 2;
      
      ctx.beginPath();
      data.forEach((d, i) => {
        const x = padding + ((d.n / maxN) * (width - 2 * padding));
        const y = height - padding - ((d.time / maxTime) * (height - 2 * padding));
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        // ç¹ªè£½æ•¸æ“šé»
        ctx.fillRect(x - 3, y - 3, 6, 6);
      });
      ctx.stroke();
      
      // ç¹ªè£½æ•¸å€¼æ¨™è¨»
      ctx.fillStyle = "#333";
      ctx.font = "10px sans-serif";
      data.forEach(d => {
        const x = padding + ((d.n / maxN) * (width - 2 * padding));
        const y = height - padding - ((d.time / maxTime) * (height - 2 * padding));
        ctx.fillText(`${d.time.toFixed(2)}s`, x + 5, y - 5);
      });
    };

    // å¼·åˆ¶åœæ­¢ï¼ˆå¯¦éš›ä¸Šå¾ˆé›£åšåˆ°ï¼Œåªæ˜¯çµ¦å€‹æç¤ºï¼‰
    document.getElementById("btn-stop").addEventListener("click", function() {
      alert("æ³¨æ„ï¼šJavaScript ç„¡æ³•çœŸæ­£ä¸­æ–· Python è¨ˆç®—\nåªèƒ½é‡æ–°æ•´ç†é é¢ä¾†åœæ­¢");
    });
  </script>
</body>
</html>
