<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è¶³çƒå‚³çƒç·´ç¿’ v4+ fix</title>
<style>
  canvas{border:3px solid #000;background:#e8e8e8}
  #info{margin-top:6px;font-family:"Noto Sans TC",sans-serif}
</style>
</head>
<body>
<canvas id="field" width="800" height="500"></canvas>
<div id="info">
  <span id="status">è¼‰å…¥ä¸­â€¦</span><br>
  ç´…éšŠé€£çºŒå‚³çƒï¼š<span id="redCnt">0</span>ã€€
  ç¶ éšŠé€£çºŒå‚³çƒï¼š<span id="grnCnt">0</span>
</div>

<script>
/* ===== å¸¸æ•¸ ===== */
const W=800, H=500;
const R_PLAYER=18, R_BALL=12, SAFE_DIST=R_PLAYER+R_BALL+4; //34
const MIN_PP_DIST = R_PLAYER * 2;   // ğŸ†• 36pxï¼šçƒå“¡-çƒå“¡æœ€å°é–“è·
const MOVE_V=1.5, CHASE_V=1.2, FRICTION=0.985;
const TEAM_RED='red', TEAM_GRN='green';
const STATE={KO_PLAYER:0,KO_EDGE:1,KO_TARGET:2,WAIT_ACT:3,WAIT_TGT:4,RUN:5};

/* ===== DOM ===== */
const canvas=document.getElementById('field'), ctx=canvas.getContext('2d');
const $st=document.getElementById('status'), $r=document.getElementById('redCnt'), $g=document.getElementById('grnCnt');
const setStatus=t=>$st.textContent=t;

/* ===== è³‡æ–™ ===== */
const players=[];
function addPlayer(x,y,t){players.push({x,y,team:t,dest:null});}
addPlayer(100,130,TEAM_RED); addPlayer(100,250,TEAM_RED); addPlayer(100,370,TEAM_RED);
addPlayer(700,130,TEAM_GRN); addPlayer(700,250,TEAM_GRN); addPlayer(700,370,TEAM_GRN);

const ball={x:W/2,y:H/2,vx:0,vy:0,holder:null};
let kickoffTeam=TEAM_RED, currentTeam=TEAM_RED;
let redPass=0, grnPass=0;
let state, selected=null, mode=null, koPlayer=null;
let lastHolder=null, launchX=0, launchY=0;

/* ===== å·¥å…· ===== */
const dist=(x1,y1,x2,y2)=>Math.hypot(x1-x2,y1-y2);
const inside=(x,y)=>x>0&&x<W&&y>0&&y<H;
const boundary=(x,y)=>x<=0||x>=W||y<=0||y>=H;
const pickPlayer=(x,y,cond)=>players.find(p=>cond(p)&&dist(p.x,p.y,x,y)<R_PLAYER);
const teamName=t=>t===TEAM_RED?'ç´…éšŠ':'ç¶ éšŠ';
const updateScore=()=>{              // <- ä¿®æ­£ï¼šç”¨å€å¡Šå¯«æ³•ï¼Œç€è¦½å™¨ä¸å†å ±éŒ¯
  $r.textContent=redPass;
  $g.textContent=grnPass;
};

/* ===== åˆå§‹é€²å…¥ç™¼çƒ ===== */
setKickoff(kickoffTeam);
updateScore();                        // é¦–æ¬¡é¡¯ç¤º 0,0

/* ===== é»æ“Š & è§¸æ§ ===== */
['click','touchstart'].forEach(evt=>{
  canvas.addEventListener(evt,e=>{
    if(evt==='touchstart'){           // å–ç¬¬ä¸€æ ¹æ‰‹æŒ‡çš„ä½ç½®
      const t=e.touches[0]; if(!t) return;
      e.clientX=t.clientX; e.clientY=t.clientY;
    }
    handleInput(e);
  },{passive:false});
});

function handleInput(e){
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left, my=e.clientY-rect.top;

  switch(state){
    /* --- ç™¼çƒä¸‰æ­¥ --- */
    case STATE.KO_PLAYER:{
      const p=pickPlayer(mx,my,pl=>pl.team===kickoffTeam);
      if(!p) return;
      koPlayer=p; state=STATE.KO_EDGE; setStatus('è«‹åœ¨é‚Šç·šé»æ“Šç™¼çƒä½ç½®'); break;
    }
    case STATE.KO_EDGE:{
      if(!boundary(mx,my)) return;
      koPlayer.x=mx; koPlayer.y=my;
      Object.assign(ball,{x:mx,y:my,vx:0,vy:0,holder:koPlayer});
      state=STATE.KO_TARGET; setStatus('åƒ…èƒ½å‚³çƒ â†’ é»æ“Šå‚³çƒç›®æ¨™'); break;
    }
    case STATE.KO_TARGET:{
      if(!inside(mx,my)) return;
      shoot(mx,my); currentTeam=kickoffTeam;
      state=STATE.RUN; setStatus(`${teamName(currentTeam)}æŒçƒä¸­â€¦`); break;
    }

    /* --- æŒçƒæŒ‡ä»¤ --- */
    case STATE.WAIT_ACT:{
      const p=pickPlayer(mx,my,pl=>pl===ball.holder);
      if(!p) return;
      selected=p;
      const act=prompt("é¸æ“‡å‹•ä½œï¼š1=ç§»å‹•åˆ°  2=å‚³åˆ°");
      if(act==='1'){mode='move';state=STATE.WAIT_TGT;setStatus('é»æ“Šç§»å‹•ç›®æ¨™');}
      else if(act==='2'){mode='pass';state=STATE.WAIT_TGT;setStatus('é»æ“Šå‚³çƒç›®æ¨™');}
      else selected=null;
      break;
    }
    case STATE.WAIT_TGT:{
      if(!selected||!mode) return;
      if(mode==='move'){
        if(!inside(mx,my)) return;
        selected.dest={x:mx,y:my}; state=STATE.RUN; setStatus('ç§»å‹•ä¸­â€¦');
      }else{
        if(!inside(mx,my)) return;
        shoot(mx,my); state=STATE.RUN; setStatus('å‚³çƒä¸­â€¦');
      }
      selected=null; mode=null; break;
    }
  }
}

/* ===== ä¸»è¿´åœˆ ===== */
function loop(){ if(state===STATE.RUN) physics(); draw(); requestAnimationFrame(loop);}
requestAnimationFrame(loop);

/* ===== ç‰©ç† ===== */
function physics(){
  /* çƒ */
  if(!ball.holder){
    ball.x+=ball.vx; ball.y+=ball.vy;
    ball.vx*=FRICTION; ball.vy*=FRICTION;

    if(!inside(ball.x,ball.y)){ switchSide('å‡ºç•Œï¼'); return; }

    for(const p of players){
      if(p===lastHolder && dist(launchX,launchY,ball.x,ball.y)<SAFE_DIST) continue;
      if(dist(p.x,p.y,ball.x,ball.y)<R_PLAYER+R_BALL){
        if(p.team===currentTeam){
          ball.holder=p; lastHolder=null; incPass();
          state=STATE.WAIT_ACT; setStatus('è«‹é»æŒçƒå“¡é¸æ“‡å‹•ä½œ');
        }else{
          switchSide(`${teamName(p.team)}æ””æˆªï¼`);
        }
        break;
      }
    }
  }else{ ball.x=ball.holder.x; ball.y=ball.holder.y; }

  /* çƒå“¡ */
  players.forEach(p=>{
    if(p.dest){
      const dx=p.dest.x-p.x, dy=p.dest.y-p.y, d=Math.hypot(dx,dy);
      if(d<MOVE_V){ p.x=p.dest.x; p.y=p.dest.y; p.dest=null;
        if(p===ball.holder){state=STATE.WAIT_ACT; setStatus('è«‹é»æŒçƒå“¡é¸æ“‡å‹•ä½œ');}}
      else{ p.x+=dx/d*MOVE_V; p.y+=dy/d*MOVE_V; }
    }else if(state===STATE.RUN && p!==ball.holder){
      const dx=ball.x-p.x, dy=ball.y-p.y, d=Math.hypot(dx,dy);
      if(d>1){ p.x+=dx/d*CHASE_V; p.y+=dy/d*CHASE_V; }
    }
  });
  /* ğŸ†• çƒå“¡-çƒå“¡ç¢°æ’åˆ†é›¢ï¼ˆé›™è¿´åœˆï¼‰ */
  for(let i=0;i<players.length;i++){
    for(let j=i+1;j<players.length;j++){
      const a=players[i], b=players[j];
      const d = dist(a.x,a.y,b.x,b.y);
      if(d>0 && d < MIN_PP_DIST){
        const overlap = (MIN_PP_DIST - d) / 2;
        const ux = (a.x - b.x) / d,  uy = (a.y - b.y) / d; // å–®ä½å‘é‡
        a.x += ux * overlap;  a.y += uy * overlap;
        b.x -= ux * overlap;  b.y -= uy * overlap;
      }
    }
  }
 
}

/* ===== è¡Œç‚º ===== */
function shoot(tx,ty){
  const dx=tx-ball.x, dy=ty-ball.y, len=Math.hypot(dx,dy)||1;
  ball.vx=dx/Math.max(7,len/7); ball.vy=dy/Math.max(7,len/7);
  lastHolder=ball.holder; launchX=ball.x; launchY=ball.y;
  ball.holder=null;
}
function incPass(){ currentTeam===TEAM_RED?++redPass:++grnPass; updateScore(); }
function switchSide(msg){
  alert(msg); redPass=grnPass=0; updateScore();
  kickoffTeam=currentTeam===TEAM_RED?TEAM_GRN:TEAM_RED; currentTeam=kickoffTeam;
  players.forEach(p=>p.dest=null); setKickoff(kickoffTeam);
}
function setKickoff(team){
  state=STATE.KO_PLAYER; ball.holder=null; Object.assign(ball,{x:W/2,y:H/2,vx:0,vy:0});
  setStatus(`${teamName(team)}ç™¼çƒï¼šè«‹é»é¸çƒå“¡`);
}

/* ===== ç¹ªåœ– ===== */
function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.beginPath(); ctx.arc(ball.x,ball.y,R_BALL,0,Math.PI*2); ctx.fillStyle='orange'; ctx.fill();
  players.forEach(p=>{
    ctx.beginPath(); ctx.arc(p.x,p.y,R_PLAYER,0,Math.PI*2);
    ctx.fillStyle=p.team; ctx.fill(); ctx.stroke();
  });
}
</script>
</body>
</html>