
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>å°¼æ³Šçˆ¾è™æ£‹ - å®Œæ•´æœ€çµ‚ç‰ˆ</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    canvas { background: #fefefe; border: 2px solid #000; margin-top: 10px; }
    button { margin: 5px; padding: 6px 12px; }
  </style>
</head>
<body>
  <h1>å°¼æ³Šçˆ¾è™æ£‹ - æœ€çµ‚åŠ å¼·ç‰ˆ</h1>
  <p id="status">éŠæˆ²é–‹å§‹ï¼Œè¼ªåˆ°å±±ç¾Šæ”¾ç½®</p>
  <p id="goatStatus">å°šæœªæ”¾ç½®å±±ç¾Šï¼š20 / æ£‹ç›¤ä¸Šå±±ç¾Šï¼š0 / è¢«åƒæ‰ï¼š0</p>
  <canvas id="board" width="500" height="500"></canvas><br>
  <button onclick="saveGame()">ğŸ’¾ å„²å­˜æ£‹å±€</button>
  <button onclick="resetGame()">ğŸ” é‡æ–°é–‹å§‹</button>

  <script>
    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");
    const statusText = document.getElementById("status");
    const goatStatusText = document.getElementById("goatStatus");

    const size = 5;
    const spacing = canvas.width / (size + 1);
    const totalGoats = 20;
    let goats = [];
    let tigers = [];
    let goatsToPlace = totalGoats;
    let turn = 'goat';
    let selectedTiger = null;
    let selectedGoat = null;
    let gameOver = false;

    function validDirs(i, j) {
      const isEven = (i + j) % 2 === 0;
      const dirs = [
        { di: 0, dj: 1 }, { di: 1, dj: 0 },
        { di: 0, dj: -1 }, { di: -1, dj: 0 }
      ];
      if (isEven) {
        dirs.push({ di: 1, dj: 1 }, { di: -1, dj: -1 }, { di: 1, dj: -1 }, { di: -1, dj: 1 });
      }
      return dirs;
    }

    function coord(i, j) {
      return { x: (i + 1) * spacing, y: (j + 1) * spacing };
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < size; i++) {
        for (let j = 0; j < size; j++) {
          const from = coord(i, j);
          for (const { di, dj } of validDirs(i, j)) {
            const ni = i + di, nj = j + dj;
            if (ni >= 0 && ni < size && nj >= 0 && nj < size) {
              const to = coord(ni, nj);
              ctx.beginPath();
              ctx.moveTo(from.x, from.y);
              ctx.lineTo(to.x, to.y);
              ctx.stroke();
            }
          }
        }
      }
      for (let i = 0; i < size; i++) {
        for (let j = 0; j < size; j++) {
          const { x, y } = coord(i, j);
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.fillStyle = "#000";
          ctx.fill();
        }
      }
      for (const g of goats) drawPiece(g, "gray");
      for (const t of tigers) drawPiece(t, "orange");

      if (selectedTiger) {
        const { x, y } = coord(selectedTiger.i, selectedTiger.j);
        ctx.beginPath();
        ctx.arc(x, y, 15, 0, Math.PI * 2);
        ctx.strokeStyle = "blue";
        ctx.stroke();
      }
      if (selectedGoat) {
        const { x, y } = coord(selectedGoat.i, selectedGoat.j);
        ctx.beginPath();
        ctx.arc(x, y, 15, 0, Math.PI * 2);
        ctx.strokeStyle = "green";
        ctx.stroke();
      }

      updateGoatStats();
    }

    function drawPiece(pos, color) {
      const { x, y } = coord(pos.i, pos.j);
      ctx.beginPath();
      ctx.arc(x, y, 12, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.fill();
    }

    function getGrid(x, y) {
      for (let i = 0; i < size; i++) {
        for (let j = 0; j < size; j++) {
          const { x: cx, y: cy } = coord(i, j);
          if (Math.hypot(cx - x, cy - y) < 15) return { i, j };
        }
      }
      return null;
    }

    function isOccupied(i, j) {
      return [...goats, ...tigers].some(p => p.i === i && p.j === j);
    }

    function findPieceAt(i, j, list) {
      return list.find(p => p.i === i && p.j === j);
    }

    function updateGoatStats() {
      const eaten = totalGoats - goats.length - goatsToPlace;
      goatStatusText.textContent =
        `å°šæœªæ”¾ç½®å±±ç¾Šï¼š${goatsToPlace} / æ£‹ç›¤ä¸Šå±±ç¾Šï¼š${goats.length} / è¢«åƒæ‰ï¼š${eaten}`;
    }

    function canTigerMove(t) {
      return validDirs(t.i, t.j).some(({ di, dj }) => {
        const ni = t.i + di, nj = t.j + dj;
        if (ni >= 0 && ni < size && nj >= 0 && nj < size) {
          if (!isOccupied(ni, nj)) return true;
          const ni2 = t.i + 2 * di, nj2 = t.j + 2 * dj;
          if (ni2 >= 0 && ni2 < size && nj2 >= 0 && nj2 < size &&
              !isOccupied(ni2, nj2) && findPieceAt(ni, nj, goats)) return true;
        }
        return false;
      });
    }

    function checkVictory() {
      const eaten = totalGoats - goats.length - goatsToPlace;
      const tigersStuck = tigers.every(t => !canTigerMove(t));
      if (tigersStuck) {
        gameOver = true;
        statusText.textContent = "å±±ç¾Šå‹åˆ©ï¼æ‰€æœ‰è€è™è¢«å›°ä½ã€‚";
      } else if (eaten >= 6) {
        gameOver = true;
        statusText.textContent = "è€è™å‹åˆ©ï¼åƒæ‰ 6 éš»å±±ç¾Šã€‚";
      }
    }

    function saveGame() {
      const state = {
        goats, tigers, goatsToPlace, turn
      };
      localStorage.setItem("baghchal_save", JSON.stringify(state));
      alert("âœ… æ£‹å±€å·²å„²å­˜ï¼");
    }

    function resetGame() {
      if (!confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²ï¼Ÿ")) return;
      startGame();
    }

    function loadGame() {
      const saved = localStorage.getItem("baghchal_save");
      if (!saved) return startGame();
      const state = JSON.parse(saved);
      goats = state.goats || [];
      tigers = state.tigers || [];
      goatsToPlace = state.goatsToPlace ?? 20;
      turn = state.turn || 'goat';
      selectedTiger = null;
      selectedGoat = null;
      gameOver = false;
      statusText.textContent = `è¼‰å…¥æˆåŠŸï¼Œè¼ªåˆ° ${turn === 'goat' ? 'å±±ç¾Š' : 'è€è™'}`;
      draw();
    }

    function startGame() {
      goats = [];
      tigers = [
        { i: 0, j: 0 }, { i: 0, j: 4 },
        { i: 4, j: 0 }, { i: 4, j: 4 }
      ];
      goatsToPlace = totalGoats;
      turn = 'goat';
      selectedTiger = null;
      selectedGoat = null;
      gameOver = false;
      statusText.textContent = "éŠæˆ²é–‹å§‹ï¼Œè¼ªåˆ°å±±ç¾Šæ”¾ç½®";
      draw();
    }

    canvas.addEventListener("click", e => {
      if (gameOver) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;
      const grid = getGrid(x, y);
      if (!grid) return;
      const { i, j } = grid;

      if (turn === 'goat') {
        if (goatsToPlace > 0 && !isOccupied(i, j)) {
          goats.push({ i, j });
          goatsToPlace--;
          turn = 'tiger';
          statusText.textContent = "è¼ªåˆ°è€è™";
        } else if (goatsToPlace === 0) {
          const g = findPieceAt(i, j, goats);
          if (g) {
            selectedGoat = (selectedGoat === g) ? null : g;
          } else if (selectedGoat && !isOccupied(i, j)) {
            const dx = i - selectedGoat.i;
            const dy = j - selectedGoat.j;
            const isValid = validDirs(selectedGoat.i, selectedGoat.j).some(d => d.di === dx && d.dj === dy);
            if (isValid) {
              selectedGoat.i = i;
              selectedGoat.j = j;
              selectedGoat = null;
              turn = 'tiger';
              statusText.textContent = "è¼ªåˆ°è€è™";
            }
          }
        }
      } else if (turn === 'tiger') {
        const t = findPieceAt(i, j, tigers);
        if (t) {
          selectedTiger = (selectedTiger === t) ? null : t;
        } else if (selectedTiger) {
          const dx = i - selectedTiger.i;
          const dy = j - selectedTiger.j;
          const isValidMove = validDirs(selectedTiger.i, selectedTiger.j).some(d => d.di === dx && d.dj === dy);
          const isValidJump = validDirs(selectedTiger.i, selectedTiger.j).some(d => d.di * 2 === dx && d.dj * 2 === dy);
          if (isValidMove && !isOccupied(i, j)) {
            selectedTiger.i = i;
            selectedTiger.j = j;
            selectedTiger = null;
            turn = 'goat';
            statusText.textContent = "è¼ªåˆ°å±±ç¾Š";
          } else if (isValidJump) {
            const mi = selectedTiger.i + dx / 2;
            const mj = selectedTiger.j + dy / 2;
            if (findPieceAt(mi, mj, goats) && !isOccupied(i, j)) {
              goats.splice(goats.indexOf(findPieceAt(mi, mj, goats)), 1);
              selectedTiger.i = i;
              selectedTiger.j = j;
              selectedTiger = null;
              turn = 'goat';
              statusText.textContent = "è¼ªåˆ°å±±ç¾Š";
            }
          }
        }
        checkVictory();
      }
      draw();
    });

    loadGame();
  </script>
</body>
</html>
