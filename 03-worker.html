<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>03. Web Worker èƒŒæ™¯è¨ˆç®—</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
  <div class="container">
    <div class="nav-links">
      <a href="index.html">â† å›é¦–é </a>
      <a href="02-compute.html">â† ä¸Šä¸€å€‹</a>
      <a href="04-data-viz.html">ä¸‹ä¸€å€‹ â†’</a>
    </div>

    <h1>03. Web Worker èƒŒæ™¯è¨ˆç®—</h1>
    <p class="subtitle">éé˜»å¡é‹ç®—ã€æ¶æ§‹è¤‡é›œåº¦ã€æ•ˆèƒ½å°æ¯”</p>

    <div class="info">
      <strong>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</strong>
      <p style="margin-top: 10px;">
        Web Worker å…è¨±åœ¨èƒŒæ™¯åŸ·è¡Œç·’é‹è¡Œä»£ç¢¼ï¼Œé¿å…é˜»å¡ UIã€‚
        ä½†éœ€è¦ <strong>JS ç•¶ä¸»æ§ã€Python ç•¶å·¥äºº</strong>ï¼Œæ¶æ§‹è¤‡é›œåº¦å¤§å¹…æå‡ã€‚
      </p>
    </div>

    <!-- åˆå§‹åŒ–ç‹€æ…‹ -->
    <div class="card">
      <h3>Worker åˆå§‹åŒ–ç‹€æ…‹</h3>
      <div class="row">
        <div>
          <span class="status-indicator status-loading" id="main-status"></span>
          ä¸»åŸ·è¡Œç·’ Python: <strong id="main-text">è¼‰å…¥ä¸­...</strong>
        </div>
        <div>
          <span class="status-indicator status-loading" id="worker-status"></span>
          Worker Python: <strong id="worker-text">ç­‰å¾…ä¸­...</strong>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="init-progress" style="width: 0%"></div>
      </div>
      <p style="color: #666; margin-top: 10px;">
        â±ï¸ Worker éœ€è¦é‡æ–°è¼‰å…¥ Pyodide + Numpyï¼Œé€šå¸¸éœ€è¦ 5-10 ç§’
      </p>
    </div>

    <!-- UI æµæš¢åº¦ç›£æ¸¬ -->
    <div class="card">
      <h3>UI æµæš¢åº¦å³æ™‚ç›£æ¸¬</h3>
      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="metric">
          <div class="metric-value" id="ui-tick">0</div>
          <div class="metric-label">UI å¿ƒè·³ (50ms)</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="ui-fps">60</div>
          <div class="metric-label">æ¸²æŸ“ FPS</div>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <canvas id="wave-canvas" width="800" height="100"></canvas>
        <p style="color: #666; margin-top: 10px;">
          ğŸ’¡ è§€å¯Ÿé‡é»ï¼šWorker è¨ˆç®—æ™‚ï¼Œæ³¢å½¢æ‡‰è©²æŒçºŒæµæš¢ï¼›ä¸»åŸ·è¡Œç·’è¨ˆç®—æ™‚æœƒå¡ä½
        </p>
      </div>
    </div>

    <!-- æ¸¬è©¦æ§åˆ¶ -->
    <div class="card">
      <h3>å°æ¯”æ¸¬è©¦æ§åˆ¶å°</h3>
      <div class="row">
        <label>çŸ©é™£å¤§å° N:</label>
        <select id="test-size">
          <option value="800">800 (è¼•é‡)</option>
          <option value="1000" selected>1000 (ä¸­ç­‰)</option>
          <option value="1200">1200 (è¼ƒé‡)</option>
          <option value="1600">1600 (é‡è² è¼‰)</option>
        </select>
      </div>
      <div class="row">
        <button id="btn-main" disabled>ä¸»åŸ·è¡Œç·’è¨ˆç®— (æœƒå¡UI)</button>
        <button id="btn-worker" disabled>Worker è¨ˆç®— (ä¸å¡UI)</button>
        <button id="btn-compare" disabled>å°æ¯”æ¸¬è©¦</button>
      </div>
      <div class="row">
        <button id="btn-stress-worker" disabled class="secondary">Worker å£“æ¸¬ (5æ¬¡)</button>
        <button id="btn-clear" class="secondary">æ¸…ç©ºæ—¥èªŒ</button>
      </div>
    </div>

    <!-- æ•ˆèƒ½å°æ¯” -->
    <div class="card">
      <h3>æ•ˆèƒ½å°æ¯”çµ±è¨ˆ</h3>
      <div class="grid">
        <div class="metric">
          <div class="metric-value" id="main-time">--</div>
          <div class="metric-label">ä¸»åŸ·è¡Œç·’æœ€å¾Œè€—æ™‚</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="worker-time">--</div>
          <div class="metric-label">Worker æœ€å¾Œè€—æ™‚</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="ui-blocked">--</div>
          <div class="metric-label">UI é˜»å¡æ™‚é•·</div>
        </div>
      </div>
      <canvas id="compare-chart" width="800" height="250"></canvas>
    </div>

    <!-- è©³ç´°æ—¥èªŒ -->
    <div class="card">
      <h3>åŸ·è¡Œæ—¥èªŒ</h3>
      <div class="output-box" id="log" style="max-height: 400px;"></div>
    </div>

    <!-- æ¶æ§‹èªªæ˜ -->
    <div class="card">
      <h3>ğŸ—ï¸ æ¶æ§‹è¤‡é›œåº¦åˆ†æ</h3>
      <div class="warning">
        <h4>ä¸»åŸ·è¡Œç·’æ¨¡å¼ï¼ˆç°¡å–®ä½†æœƒå¡ï¼‰</h4>
        <pre style="background: white; color: #333; padding: 10px; border-radius: 4px;">
Python (ä¸»åŸ·è¡Œç·’) â†’ ç›´æ¥è¨ˆç®— â†’ æ›´æ–° DOM
âœ… æ¶æ§‹ç°¡å–®
âŒ UI å®Œå…¨é˜»å¡</pre>
      </div>
      <div class="success">
        <h4>Worker æ¨¡å¼ï¼ˆè¤‡é›œä½†æµæš¢ï¼‰</h4>
        <pre style="background: white; color: #333; padding: 10px; border-radius: 4px;">
JS (ä¸»åŸ·è¡Œç·’) â†’ postMessage â†’ Worker Python â†’ è¨ˆç®—
              â†‘                              â†“
              â† â† â† â† postMessage å›å‚³çµæœ â† â†
âœ… UI å®Œå…¨æµæš¢
âŒ æ¶æ§‹è¤‡é›œï¼šéœ€è¦ JS ç®¡ç†ã€è³‡æ–™åºåˆ—åŒ–ã€éŒ¯èª¤è™•ç†å›°é›£</pre>
      </div>
      <p style="margin-top: 15px; color: #666;">
        <strong>é—œéµå–æ¨ï¼š</strong>
        å¦‚æœéœ€è¦ã€Œç”¢å“ç´šçš„æµæš¢é«”é©—ã€ï¼Œå°±å¿…é ˆæ¥å—ã€Œå·¥ç¨‹è¤‡é›œåº¦çš„å¤§å¹…æå‡ã€ã€‚
        é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼å¤§å¤šæ•¸ç”Ÿç”¢ç’°å¢ƒä»ç„¶é¸æ“‡ç´” JS æ–¹æ¡ˆã€‚
      </p>
    </div>

  </div>

  <!-- PyScript ä¸»åŸ·è¡Œç·’ -->
  <py-config>
    packages = ["numpy"]
  </py-config>

  <py-script>
from pyscript import document, window
import time

log_el = document.querySelector("#log")

def log(msg, level="info"):
    timestamp = time.strftime("%H:%M:%S")
    prefix = {"info": "â„¹ï¸", "success": "âœ…", "warning": "âš ï¸", "error": "âŒ", "compute": "ğŸ”¢"}.get(level, "â„¹ï¸")
    log_el.innerText += f"[{timestamp}] {prefix} {msg}\n"
    log_el.scrollTop = log_el.scrollHeight

def main_compute(*args):
    """ä¸»åŸ·è¡Œç·’è¨ˆç®—"""
    import numpy as np
    
    n = int(document.querySelector("#test-size").value)
    log(f"ä¸»åŸ·è¡Œç·’é–‹å§‹è¨ˆç®— N={n}", "compute")
    
    # é€šçŸ¥ JS é–‹å§‹è¨ˆæ™‚
    window.startMainTimer()
    
    try:
        t0 = time.perf_counter()
        a = np.random.rand(n, n).astype(np.float32)
        b = np.random.rand(n, n).astype(np.float32)
        c = a @ b
        t1 = time.perf_counter()
        
        elapsed = t1 - t0
        checksum = float(c[0, 0])
        
        log(f"ä¸»åŸ·è¡Œç·’å®Œæˆ | è€—æ™‚: {elapsed:.3f}s | Checksum: {checksum:.6f}", "success")
        
        # æ›´æ–°é¡¯ç¤º
        document.querySelector("#main-time").innerText = f"{elapsed:.3f}s"
        window.endMainTimer(elapsed)
        
    except Exception as e:
        log(f"ä¸»åŸ·è¡Œç·’éŒ¯èª¤: {e}", "error")
        window.endMainTimer(0)

def clear_log(*args):
    log_el.innerText = ""
    log("æ—¥èªŒå·²æ¸…ç©º", "info")

# ç¶å®šäº‹ä»¶
document.querySelector("#btn-main").addEventListener("click", main_compute)
document.querySelector("#btn-clear").addEventListener("click", clear_log)

# é€šçŸ¥ JSï¼šä¸»åŸ·è¡Œç·’ Python å·²å°±ç·’
window.mainPythonReady = True
log("âœ… ä¸»åŸ·è¡Œç·’ Python å·²å°±ç·’", "success")
document.querySelector("#main-status").className = "status-indicator status-ready"
document.querySelector("#main-text").innerText = "å°±ç·’"
  </py-script>

  <!-- JavaScript ä¸»æ§é‚è¼¯ -->
  <script>
    let worker = null;
    let workerReady = false;
    let mainTimerStart = 0;
    let uiTick = 0;
    let lastFrameTime = performance.now();
    let compareData = { main: [], worker: [] };

    // UI å¿ƒè·³
    setInterval(() => {
      uiTick++;
      document.getElementById("ui-tick").textContent = uiTick;
      
      const now = performance.now();
      const fps = Math.round(1000 / (now - lastFrameTime));
      lastFrameTime = now;
      document.getElementById("ui-fps").textContent = fps;
    }, 50);

    // ç¹ªè£½æ³¢å½¢ï¼ˆè¦–è¦ºåŒ– UI æµæš¢åº¦ï¼‰
    const waveCanvas = document.getElementById("wave-canvas");
    const waveCtx = waveCanvas.getContext("2d");
    let waveOffset = 0;

    function drawWave() {
      const width = waveCanvas.width;
      const height = waveCanvas.height;
      
      waveCtx.fillStyle = "#f0f0f0";
      waveCtx.fillRect(0, 0, width, height);
      
      waveCtx.strokeStyle = "#667eea";
      waveCtx.lineWidth = 2;
      waveCtx.beginPath();
      
      for (let x = 0; x < width; x++) {
        const y = height / 2 + Math.sin((x + waveOffset) * 0.02) * 30;
        if (x === 0) waveCtx.moveTo(x, y);
        else waveCtx.lineTo(x, y);
      }
      
      waveCtx.stroke();
      waveOffset += 5;
      
      requestAnimationFrame(drawWave);
    }
    drawWave();

    // åˆå§‹åŒ– Worker
    function initWorker() {
      const workerCode = `
        importScripts('https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js');
        
        let pyodide = null;
        
        async function init() {
          self.postMessage({ type: 'status', message: 'è¼‰å…¥ Pyodide...' });
          pyodide = await loadPyodide();
          
          self.postMessage({ type: 'status', message: 'è¼‰å…¥ NumPy...' });
          await pyodide.loadPackage('numpy');
          
          self.postMessage({ type: 'ready' });
        }
        
        self.onmessage = async function(e) {
          if (e.data.type === 'compute') {
            const n = e.data.n;
            const t0 = performance.now();
            
            try {
              const result = await pyodide.runPythonAsync(\`
import numpy as np

a = np.random.rand(${n}, ${n}).astype(np.float32)
b = np.random.rand(${n}, ${n}).astype(np.float32)
c = a @ b

{
  "checksum": float(c[0, 0]),
  "n": ${n}
}
              \`);
              
              const t1 = performance.now();
              const data = result.toJs();
              
              self.postMessage({
                type: 'result',
                time: (t1 - t0) / 1000,
                checksum: data.get('checksum'),
                n: data.get('n')
              });
            } catch (error) {
              self.postMessage({
                type: 'error',
                message: error.toString()
              });
            }
          }
        };
        
        init();
      `;

      const blob = new Blob([workerCode], { type: 'application/javascript' });
      worker = new Worker(URL.createObjectURL(blob));

      worker.onmessage = function(e) {
        const logEl = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();

        if (e.data.type === 'status') {
          logEl.innerText += `[${timestamp}] ğŸ”„ Worker: ${e.data.message}\n`;
          logEl.scrollTop = logEl.scrollHeight;
          
          document.getElementById("init-progress").style.width = "50%";
        } else if (e.data.type === 'ready') {
          workerReady = true;
          logEl.innerText += `[${timestamp}] âœ… Worker Python å·²å°±ç·’\n`;
          logEl.scrollTop = logEl.scrollHeight;
          
          document.getElementById("worker-status").className = "status-indicator status-ready";
          document.getElementById("worker-text").innerText = "å°±ç·’";
          document.getElementById("init-progress").style.width = "100%";
          
          enableButtons();
        } else if (e.data.type === 'result') {
          const { time, checksum, n } = e.data;
          logEl.innerText += `[${timestamp}] âœ… Worker å®Œæˆ N=${n} | è€—æ™‚: ${time.toFixed(3)}s | Checksum: ${checksum.toFixed(6)}\n`;
          logEl.scrollTop = logEl.scrollHeight;
          
          document.getElementById("worker-time").textContent = `${time.toFixed(3)}s`;
          document.getElementById("ui-blocked").textContent = "0.00s";
          
          compareData.worker.push({ n, time });
          updateCompareChart();
          enableButtons();
        } else if (e.data.type === 'error') {
          logEl.innerText += `[${timestamp}] âŒ Worker éŒ¯èª¤: ${e.data.message}\n`;
          logEl.scrollTop = logEl.scrollHeight;
          enableButtons();
        }
      };
    }

    function enableButtons() {
      if (window.mainPythonReady && workerReady) {
        document.getElementById("btn-main").disabled = false;
        document.getElementById("btn-worker").disabled = false;
        document.getElementById("btn-compare").disabled = false;
        document.getElementById("btn-stress-worker").disabled = false;
      }
    }

    // Worker è¨ˆç®—
    document.getElementById("btn-worker").addEventListener("click", function() {
      const n = parseInt(document.getElementById("test-size").value);
      const logEl = document.getElementById("log");
      const timestamp = new Date().toLocaleTimeString();
      
      logEl.innerText += `[${timestamp}] ğŸ”¢ Worker é–‹å§‹è¨ˆç®— N=${n}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      
      this.disabled = true;
      worker.postMessage({ type: 'compute', n });
    });

    // å°æ¯”æ¸¬è©¦
    document.getElementById("btn-compare").addEventListener("click", async function() {
      const logEl = document.getElementById("log");
      logEl.innerText += "\n=== é–‹å§‹å°æ¯”æ¸¬è©¦ ===\n";
      
      this.disabled = true;
      
      // å…ˆæ¸¬ä¸»åŸ·è¡Œç·’
      document.getElementById("btn-main").click();
      
      // ç­‰å¾… 2 ç§’
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // å†æ¸¬ Worker
      document.getElementById("btn-worker").click();
      
      setTimeout(() => {
        logEl.innerText += "=== å°æ¯”æ¸¬è©¦å®Œæˆ ===\n";
        this.disabled = false;
      }, 3000);
    });

    // Worker å£“æ¸¬
    document.getElementById("btn-stress-worker").addEventListener("click", async function() {
      const n = parseInt(document.getElementById("test-size").value);
      const logEl = document.getElementById("log");
      
      logEl.innerText += "\n=== Worker å£“åŠ›æ¸¬è©¦é–‹å§‹ (5æ¬¡) ===\n";
      this.disabled = true;
      
      for (let i = 0; i < 5; i++) {
        logEl.innerText += `--- ç¬¬ ${i + 1}/5 è¼ª ---\n`;
        worker.postMessage({ type: 'compute', n });
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
      
      logEl.innerText += "=== å£“åŠ›æ¸¬è©¦å®Œæˆ ===\n";
      this.disabled = false;
    });

    // ä¸»åŸ·è¡Œç·’è¨ˆæ™‚å™¨
    window.startMainTimer = function() {
      mainTimerStart = performance.now();
    };

    window.endMainTimer = function(computeTime) {
      const uiBlockTime = (performance.now() - mainTimerStart) / 1000;
      document.getElementById("ui-blocked").textContent = `${uiBlockTime.toFixed(3)}s`;
      
      const n = parseInt(document.getElementById("test-size").value);
      compareData.main.push({ n, time: computeTime });
      updateCompareChart();
    };

    // å°æ¯”åœ–è¡¨
    function updateCompareChart() {
      const canvas = document.getElementById("compare-chart");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      const padding = 50;
      
      ctx.fillStyle = "#fafafa";
      ctx.fillRect(0, 0, width, height);
      
      if (compareData.main.length === 0 && compareData.worker.length === 0) return;
      
      // åº§æ¨™è»¸
      ctx.strokeStyle = "#999";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();
      
      // ç¹ªè£½æ•¸æ“š
      const allData = [...compareData.main, ...compareData.worker];
      const maxTime = Math.max(...allData.map(d => d.time));
      const maxN = Math.max(...allData.map(d => d.n));
      
      // ä¸»åŸ·è¡Œç·’æ•¸æ“šï¼ˆç´…è‰²ï¼‰
      if (compareData.main.length > 0) {
        ctx.strokeStyle = "#ff6b6b";
        ctx.fillStyle = "#ff6b6b";
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        compareData.main.forEach((d, i) => {
          const x = padding + ((d.n / maxN) * (width - 2 * padding));
          const y = height - padding - ((d.time / maxTime) * (height - 2 * padding));
          
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
          
          ctx.fillRect(x - 4, y - 4, 8, 8);
        });
        ctx.stroke();
      }
      
      // Worker æ•¸æ“šï¼ˆè—è‰²ï¼‰
      if (compareData.worker.length > 0) {
        ctx.strokeStyle = "#4dabf7";
        ctx.fillStyle = "#4dabf7";
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        compareData.worker.forEach((d, i) => {
          const x = padding + ((d.n / maxN) * (width - 2 * padding));
          const y = height - padding - ((d.time / maxTime) * (height - 2 * padding));
          
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
          
          ctx.fillRect(x - 4, y - 4, 8, 8);
        });
        ctx.stroke();
      }
      
      // åœ–ä¾‹
      ctx.fillStyle = "#ff6b6b";
      ctx.fillRect(width - 150, 20, 15, 15);
      ctx.fillStyle = "#333";
      ctx.font = "12px sans-serif";
      ctx.fillText("ä¸»åŸ·è¡Œç·’", width - 130, 32);
      
      ctx.fillStyle = "#4dabf7";
      ctx.fillRect(width - 150, 45, 15, 15);
      ctx.fillText("Worker", width - 130, 57);
    }

    // å•Ÿå‹•
    setTimeout(() => {
      initWorker();
      
      const checkReady = setInterval(() => {
        if (window.mainPythonReady && workerReady) {
          clearInterval(checkReady);
        }
      }, 100);
    }, 1000);
  </script>
</body>
</html>
