<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>次音波轉音波 v3 - 示波顯示</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;margin:0;padding:20px;background:#0a0f18;color:#e6e8f0;}
.card{max-width:920px;margin:20px auto;background:#101621;border-radius:12px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,0.5);}
h1{margin:0 0 12px;font-size:22px;color:#7fff7f;}
label{display:block;font-size:13px;margin:6px 0;color:#a0b0c0;}
.range-row{display:flex;align-items:center;gap:10px;}
input[type=range]{flex:1;}
button{padding:8px 12px;margin-right:6px;border:none;border-radius:6px;cursor:pointer;}
button.primary{background:#1fb64f;color:#fff;}
button.secondary{background:#2a3240;color:#e6e8f0;}
#status{margin-top:10px;font-size:13px;color:#9fb0c0;}
canvas{width:100%;height:200px;background:#000;border-radius:8px;margin-bottom:12px;}
</style>
</head>
<body>
<div class="card">
<h1>次音波轉音波 v3</h1>
<canvas id="oscilloscope"></canvas>

<label>低端頻率 (Hz)：<span id="lowVal">5</span></label>
<div class="range-row"><input id="lowSlider" type="range" min="0" max="20" step="0.1" value="5"></div>

<label>高端頻率 (Hz)：<span id="highVal">15</span></label>
<div class="range-row"><input id="highSlider" type="range" min="0" max="20" step="0.1" value="15"></div>

<label>頻率倍率 (×)：<span id="multVal">1000</span></label>
<div class="range-row"><input id="multSlider" type="range" min="1" max="2000" step="1" value="1000"></div>

<label>增益 (dB)：<span id="gainVal">20</span></label>
<div class="range-row"><input id="gainSlider" type="range" min="20" max="60" step="1" value="20"></div>

<label>音高 (Pitch)：<span id="pitchVal">1.0x</span></label>
<div class="range-row"><input id="pitchSlider" type="range" min="0.5" max="2.0" step="0.01" value="1"></div>

<div style="margin-top:14px;">
  <button class="primary" id="startMic">啟用麥克風</button>
  <button class="secondary" id="stopMic">停止</button>
  <button class="secondary" id="download">匯出 WAV</button>
</div>

<div id="status">等待操作...</div>
</div>

<script>
let audioCtx, source, analyser, dataArray, bufferLength;
let mediaStream;

const canvas = document.getElementById('oscilloscope');
const ctx = canvas.getContext('2d');

const lowSlider=document.getElementById('lowSlider');
const highSlider=document.getElementById('highSlider');
const multSlider=document.getElementById('multSlider');
const gainSlider=document.getElementById('gainSlider');
const pitchSlider=document.getElementById('pitchSlider');

const lowVal=document.getElementById('lowVal');
const highVal=document.getElementById('highVal');
const multVal=document.getElementById('multVal');
const gainVal=document.getElementById('gainVal');
const pitchVal=document.getElementById('pitchVal');
const statusDiv=document.getElementById('status');

function updateLabels(){
 lowVal.textContent=lowSlider.value;
 highVal.textContent=highSlider.value;
 multVal.textContent=multSlider.value;
 gainVal.textContent=gainSlider.value;
 pitchVal.textContent=pitchSlider.value+'x';
 statusDiv.textContent=`範圍 ${lowSlider.value}-${highSlider.value} Hz, 倍率 ×${multSlider.value}, 增益 +${gainSlider.value} dB, 音高 ${pitchSlider.value}x`;
}
[lowSlider,highSlider,multSlider,gainSlider,pitchSlider].forEach(s=>s.addEventListener('input',updateLabels));
updateLabels();

async function startMic(){
 audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});
 source=audioCtx.createMediaStreamSource(mediaStream);
 analyser=audioCtx.createAnalyser();
 analyser.fftSize=2048;
 bufferLength=analyser.fftSize;
 dataArray=new Uint8Array(bufferLength);

 let low=parseFloat(lowSlider.value);
 let high=parseFloat(highSlider.value);
 let mult=parseFloat(multSlider.value);

 let bandpass=audioCtx.createBiquadFilter();
 bandpass.type='bandpass';
 bandpass.frequency.value=(low+high)/2;
 bandpass.Q.value=Math.max((high-low)/2,0.001);

 const modNode=audioCtx.createScriptProcessor(2048,1,1);
 let t=0;
 modNode.onaudioprocess=e=>{
   const input=e.inputBuffer.getChannelData(0);
   const output=e.outputBuffer.getChannelData(0);
   const rate=mult;
   for(let i=0;i<input.length;i++){
     output[i]=input[i]*Math.sin(2*Math.PI*rate*t/audioCtx.sampleRate);
     t++;
   }
 };

 const gain=audioCtx.createGain();
 gain.gain.value=Math.pow(10,parseFloat(gainSlider.value)/20);

 source.connect(bandpass);
 bandpass.connect(modNode);
 modNode.connect(gain);
 gain.connect(analyser);
 analyser.connect(audioCtx.destination);

 drawOscilloscope();
 statusDiv.textContent='麥克風啟用中...';
}

document.getElementById('startMic').onclick=startMic;
document.getElementById('stopMic').onclick=()=>{if(mediaStream){mediaStream.getTracks().forEach(t=>t.stop());statusDiv.textContent='已停止';}};

function drawOscilloscope(){
 requestAnimationFrame(drawOscilloscope);
 analyser.getByteTimeDomainData(dataArray);
 ctx.fillStyle='#000';
 ctx.fillRect(0,0,canvas.width,canvas.height);
 ctx.lineWidth=2;
 ctx.strokeStyle='#00ff66';
 ctx.beginPath();
 let sliceWidth=canvas.width*1.0/bufferLength;
 let x=0;
 for(let i=0;i<bufferLength;i++){
   let v=dataArray[i]/128.0;
   let y=v*canvas.height/2;
   if(i===0) ctx.moveTo(x,y);
   else ctx.lineTo(x,y);
   x+=sliceWidth;
 }
 ctx.lineTo(canvas.width,canvas.height/2);
 ctx.stroke();
}
</script>
</body>
</html>
