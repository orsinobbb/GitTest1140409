<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PyScript å®Œæ•´æ¸¬è©¦ - Proxy Safe ç‰ˆï¼ˆå®Œæ•´ç‰ˆå¯ç”¨ï¼‰</title>

  <!-- âœ… PyScript core å›ºå®šç‰ˆæœ¬ -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { color: #667eea; margin-bottom: 10px; }
    h3 { color: #555; margin: 20px 0 10px 0; }
    .subtitle { color: #666; font-size: 1.1em; margin-bottom: 20px; }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      background: #fafafa;
    }
    .info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 1em;
      transition: transform 0.2s;
    }
    button:hover { transform: translateY(-2px); }
    button.secondary { background: #6c757d; }
    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin: 5px;
      font-size: 1em;
    }
    .output {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      max-height: 220px;
      overflow-y: auto;
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    .metric {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      min-width: 120px;
    }
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    .metric-label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }
    code { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ PyScript å®Œæ•´åŠŸèƒ½æ¸¬è©¦</h1>
    <p class="subtitle">Proxy-Safe ç‰ˆæœ¬ï¼ˆå®Œæ•´ç‰ˆå¯ç”¨ï¼‰</p>

    <div class="info">
      <strong>âœ… æœ¬ç‰ˆæœ¬å·²è™•ç†</strong>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li><code>create_proxy</code>ï¼šé¿å… borrowed proxy destroyed</li>
        <li>Guardï¼šé¿å… reload / hot-reload é‡è¤‡ç¶å®šé€ æˆèˆŠ proxy æ›åœ¨ DOM</li>
        <li>Event å€¼å…ˆè¤‡è£½ï¼šé¿å… event borrowed proxy å»¶å¾Œå­˜å–å‡ºéŒ¯</li>
        <li>å›ºå®šç‰ˆæœ¬ coreï¼šé¿å… <code>latest</code> ä¸ç©©èˆ‡ CORB</li>
      </ul>
    </div>

    <!-- æ¸¬è©¦ 1 -->
    <div class="card">
      <h3>æ¸¬è©¦ 1: DOM æ“ä½œ</h3>
      <div class="row">
        <input type="text" id="input1" value="Hello PyScript" placeholder="è¼¸å…¥æ–‡å­—">
        <button id="btn-update">æ›´æ–°é¡¯ç¤º</button>
        <button id="btn-clear" class="secondary">æ¸…ç©º</button>
      </div>
      <div class="output" id="output1">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <!-- æ¸¬è©¦ 2 -->
    <div class="card">
      <h3>æ¸¬è©¦ 2: NumPy é™£åˆ—è¨ˆç®—</h3>
      <div class="row">
        <label>é™£åˆ—å¤§å°:</label>
        <input type="number" id="array-size" value="1000" min="100" max="200000" step="100" style="width: 140px;">
        <button id="btn-compute">åŸ·è¡Œè¨ˆç®—</button>
      </div>
      <div class="output" id="output2">ç­‰å¾…è¨ˆç®—...</div>
    </div>

    <!-- æ¸¬è©¦ 3 -->
    <div class="card">
      <h3>æ¸¬è©¦ 3: å¤šç¨®äº‹ä»¶è™•ç†</h3>
      <div class="row">
        <button id="btn-click">å–®æ“Š</button>
        <button id="btn-dblclick">é›™æ“Š</button>
        <button id="btn-context">å³éµé¸å–®</button>
      </div>
      <div class="row">
        <input type="range" id="slider" min="0" max="100" value="50">
        <span id="slider-value">50</span>
      </div>
      <div class="output" id="output3">ç­‰å¾…äº‹ä»¶è§¸ç™¼...</div>
    </div>

    <!-- æ¸¬è©¦ 4 -->
    <div class="card">
      <h3>æ¸¬è©¦ 4: Python â†” JS è³‡æ–™äº’é€š</h3>
      <div class="row">
        <button id="btn-py-to-js">Python â†’ JS</button>
        <button id="btn-js-to-py">JS â†’ Python</button>
        <button id="btn-complex">è¤‡é›œè³‡æ–™</button>
      </div>
      <div class="output" id="output4">ç­‰å¾…è³‡æ–™å‚³é...</div>
    </div>

    <!-- æ¸¬è©¦ 5 -->
    <div class="card">
      <h3>æ¸¬è©¦ 5: å‹•æ…‹ç”Ÿæˆå…ƒç´ </h3>
      <div class="row">
        <input type="number" id="num-items" value="5" min="1" max="20" style="width: 120px;">
        <button id="btn-generate">ç”Ÿæˆåˆ—è¡¨</button>
        <button id="btn-remove" class="secondary">æ¸…ç©º</button>
      </div>
      <div id="dynamic-content"></div>
    </div>

    <!-- æ¸¬è©¦ 6 -->
    <div class="card">
      <h3>æ¸¬è©¦ 6: CSS å‹•æ…‹æ§åˆ¶</h3>
      <div class="row">
        <button id="btn-red">ç´…è‰²</button>
        <button id="btn-blue">è—è‰²</button>
        <button id="btn-green">ç¶ è‰²</button>
        <button id="btn-animate" class="secondary">å‹•ç•«</button>
      </div>
      <div id="color-box"
           style="width: 200px; height: 100px; background: #eee; border-radius: 8px; margin: 10px 0; transition: all 0.5s;">
      </div>
    </div>

    <!-- çµ±è¨ˆ -->
    <div class="card">
      <h3>æ•ˆèƒ½çµ±è¨ˆ</h3>
      <div class="row">
        <div class="metric">
          <div class="metric-value" id="event-count">0</div>
          <div class="metric-label">äº‹ä»¶è§¸ç™¼æ¬¡æ•¸</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="dom-ops">0</div>
          <div class="metric-label">DOM æ“ä½œæ¬¡æ•¸</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="load-time">--</div>
          <div class="metric-label">è¼‰å…¥æ™‚é–“ (ç§’)</div>
        </div>
      </div>
      <div class="output" id="log">log:\n</div>
    </div>
  </div>

  <!-- âœ… PyScript è¨­å®š -->
  <py-config>
packages = ["numpy"]
  </py-config>

  <!-- âœ… PyScript ç¨‹å¼ -->
  <script type="py">
from pyscript import document, window
from pyodide.ffi import create_proxy
import time

# ----------------------------
# å°å·¥å…·
# ----------------------------
def log(msg: str):
    el = document.querySelector("#log")
    el.textContent = el.textContent + str(msg) + "\n"

def now_str():
    return time.strftime("%H:%M:%S")

start_time = time.time()
event_count = 0
dom_ops = 0

def update_stats():
    global dom_ops
    dom_ops += 1
    document.querySelector("#event-count").innerText = str(event_count)
    document.querySelector("#dom-ops").innerText = str(dom_ops)

# ----------------------------
# æ¸¬è©¦ 1: DOM
# ----------------------------
def update_output(evt):
    global event_count
    event_count += 1

    # âœ… ä¸è¦æŠŠ evt ç•™è‘—ï¼›åªå–å¿…è¦å€¼æˆç´” Python
    etype = evt.type

    val = document.querySelector("#input1").value
    out = document.querySelector("#output1")
    out.innerText = f"[{now_str()}] ({etype}) è¼¸å…¥: {val}\nå­—å…ƒæ•¸: {len(val)}"
    update_stats()

def clear_input(evt):
    global event_count
    event_count += 1

    document.querySelector("#input1").value = ""
    document.querySelector("#output1").innerText = "å·²æ¸…ç©º"
    update_stats()

# ----------------------------
# æ¸¬è©¦ 2: NumPy
# ----------------------------
def compute_numpy(evt):
    import numpy as np
    global event_count
    event_count += 1

    size = int(document.querySelector("#array-size").value)
    out = document.querySelector("#output2")
    out.innerText = f"æ­£åœ¨è¨ˆç®— {size} å€‹å…ƒç´ ...\n"

    t0 = time.perf_counter()
    arr = np.random.rand(size).astype(np.float32)
    mean = float(arr.mean())
    std = float(arr.std())
    mn = float(arr.min())
    mx = float(arr.max())
    t1 = time.perf_counter()

    out.innerText += (
        "âœ… è¨ˆç®—å®Œæˆï¼\n"
        f"å¹³å‡å€¼: {mean:.6f}\n"
        f"æ¨™æº–å·®: {std:.6f}\n"
        f"æœ€å°å€¼: {mn:.6f}\n"
        f"æœ€å¤§å€¼: {mx:.6f}\n"
        f"è€—æ™‚: {(t1 - t0):.3f} ç§’\n"
    )
    update_stats()

# ----------------------------
# æ¸¬è©¦ 3: äº‹ä»¶
# ----------------------------
def handle_click(evt):
    global event_count
    event_count += 1
    etype = evt.type
    out = document.querySelector("#output3")
    out.innerText = f"[{now_str()}] äº‹ä»¶è§¸ç™¼ï¼š{etype}"
    update_stats()

def handle_dblclick(evt):
    global event_count
    event_count += 1
    etype = evt.type
    out = document.querySelector("#output3")
    out.innerText = f"[{now_str()}] äº‹ä»¶è§¸ç™¼ï¼š{etype}"
    update_stats()

def handle_context(evt):
    global event_count
    event_count += 1

    # âœ… å…ˆå–å€¼ï¼Œå† preventDefault
    etype = evt.type
    x = int(evt.clientX)
    y = int(evt.clientY)
    evt.preventDefault()

    out = document.querySelector("#output3")
    out.innerText = f"[{now_str()}] ({etype}) å³éµè¢«æ””æˆªï¼\nä½ç½®: ({x}, {y})"
    update_stats()

def handle_slider(evt):
    global event_count
    event_count += 1
    value = document.querySelector("#slider").value
    document.querySelector("#slider-value").innerText = value
    update_stats()

# ----------------------------
# æ¸¬è©¦ 4: Python â†” JS
# ----------------------------
def py_to_js(evt):
    global event_count
    event_count += 1

    data = {
        "message": "å¾ Python å‚³ä¾†çš„è³‡æ–™",
        "timestamp": time.time(),
        "list": [1, 2, 3, 4, 5],
        "nested": {"key": "value", "number": 42}
    }
    window.pyData = data
    window.displayPyData()
    update_stats()

def js_to_py(evt):
    global event_count
    event_count += 1
    window.sendDataToPython()
    update_stats()

def complex_data(evt):
    import numpy as np
    global event_count
    event_count += 1

    arr = np.array([1, 2, 3, 4, 5], dtype=np.int32)
    out = document.querySelector("#output4")
    out.innerText = (
        "NumPy é™£åˆ—è™•ç†ï¼š\n"
        f"åŸå§‹: {arr.tolist()}\n"
        f"å¹³æ–¹: {(arr**2).tolist()}\n"
        f"ç¸½å’Œ: {int(arr.sum())}\n\n"
        "âš ï¸ NumPy array è¦å‚³ JSï¼šå…ˆ .tolist()"
    )
    update_stats()

# ----------------------------
# æ¸¬è©¦ 5: å‹•æ…‹å…ƒç´ 
# ----------------------------
def generate_items(evt):
    global event_count
    event_count += 1

    num = int(document.querySelector("#num-items").value)
    container = document.querySelector("#dynamic-content")
    container.innerHTML = ""

    for i in range(num):
        item = document.createElement("div")
        item.className = "card"
        item.style.padding = "10px"
        item.style.margin = "5px 0"
        item.innerHTML = f"""
            <strong>é …ç›® {i+1}</strong>
            <p>é€™æ˜¯ç”± Python å‹•æ…‹ç”Ÿæˆçš„å…ƒç´ </p>
            <button onclick="alert('é …ç›® {i+1} è¢«é»æ“Š')">é»æˆ‘</button>
        """
        container.appendChild(item)

    update_stats()

def remove_items(evt):
    global event_count
    event_count += 1
    document.querySelector("#dynamic-content").innerHTML = ""
    update_stats()

# ----------------------------
# æ¸¬è©¦ 6: æ¨£å¼
# ----------------------------
def make_color_handler(color):
    def _h(evt):
        global event_count
        event_count += 1
        box = document.querySelector("#color-box")
        box.style.background = color
        update_stats()
    return _h

def animate_box(evt):
    import random
    global event_count
    event_count += 1

    box = document.querySelector("#color-box")
    box.style.width = f"{random.randint(100, 400)}px"
    box.style.height = f"{random.randint(50, 200)}px"
    box.style.borderRadius = f"{random.randint(0, 50)}px"
    box.style.transform = f"rotate({random.randint(-15, 15)}deg)"
    update_stats()

# ----------------------------
# âœ… Guardï¼šé¿å…é‡è¤‡ç¶å®šé€ æˆèˆŠ proxy ä»æ›åœ¨ DOM
# ----------------------------
if hasattr(window, "_pyscript_bound") and window._pyscript_bound:
    log("âš ï¸ å·²ç¶å®šéäº‹ä»¶ï¼ˆå¯èƒ½æ˜¯ reload/hot-reloadï¼‰ï¼Œç•¥éé‡è¤‡ç¶å®šã€‚")
else:
    window._pyscript_bound = True
    log("ğŸ”§ å»ºç«‹ proxies...")

    proxies = {
        "update": create_proxy(update_output),
        "clear": create_proxy(clear_input),
        "compute": create_proxy(compute_numpy),

        "click": create_proxy(handle_click),
        "dblclick": create_proxy(handle_dblclick),
        "context": create_proxy(handle_context),
        "slider": create_proxy(handle_slider),

        "py_to_js": create_proxy(py_to_js),
        "js_to_py": create_proxy(js_to_py),
        "complex": create_proxy(complex_data),

        "generate": create_proxy(generate_items),
        "remove": create_proxy(remove_items),

        "red": create_proxy(make_color_handler("#ff6b6b")),
        "blue": create_proxy(make_color_handler("#4dabf7")),
        "green": create_proxy(make_color_handler("#51cf66")),
        "animate": create_proxy(animate_box),
    }

    # æŠŠ proxies å­˜åˆ° windowï¼Œé¿å…è¢« Python GCï¼ˆæ›´ä¿éšªï¼‰
    window._pyscript_proxies = proxies

    log("ğŸ”— ç¶å®šäº‹ä»¶...")

    document.querySelector("#btn-update").addEventListener("click", proxies["update"])
    document.querySelector("#btn-clear").addEventListener("click", proxies["clear"])

    document.querySelector("#btn-compute").addEventListener("click", proxies["compute"])

    document.querySelector("#btn-click").addEventListener("click", proxies["click"])
    document.querySelector("#btn-dblclick").addEventListener("dblclick", proxies["dblclick"])
    document.querySelector("#btn-context").addEventListener("contextmenu", proxies["context"])
    document.querySelector("#slider").addEventListener("input", proxies["slider"])

    document.querySelector("#btn-py-to-js").addEventListener("click", proxies["py_to_js"])
    document.querySelector("#btn-js-to-py").addEventListener("click", proxies["js_to_py"])
    document.querySelector("#btn-complex").addEventListener("click", proxies["complex"])

    document.querySelector("#btn-generate").addEventListener("click", proxies["generate"])
    document.querySelector("#btn-remove").addEventListener("click", proxies["remove"])

    document.querySelector("#btn-red").addEventListener("click", proxies["red"])
    document.querySelector("#btn-blue").addEventListener("click", proxies["blue"])
    document.querySelector("#btn-green").addEventListener("click", proxies["green"])
    document.querySelector("#btn-animate").addEventListener("click", proxies["animate"])

    log("âœ… ç¶å®šå®Œæˆï¼Œå¯åè¦†é»æ“Šä¸æœƒå´©ã€‚")

# ----------------------------
# åˆå§‹åŒ–å®Œæˆ
# ----------------------------
load_time = time.time() - start_time
document.querySelector("#load-time").innerText = f"{load_time:.2f}"
log(f"âœ… PyScript åˆå§‹åŒ–å®Œæˆï¼š{load_time:.2f}s")
  </script>

  <!-- âœ… JS è¼”åŠ© -->
  <script>
    window.displayPyData = function () {
      const output = document.querySelector("#output4");
      const data = window.pyData;
      output.textContent = `JS æ”¶åˆ° Python çš„è³‡æ–™ï¼š\n${JSON.stringify(data, null, 2)}`;
    };

    window.sendDataToPython = function () {
      const jsData = {
        message: "å¾ JS å‚³ä¾†çš„è³‡æ–™",
        timestamp: Date.now(),
        userAgent: navigator.userAgent.slice(0, 80),
        platform: navigator.platform
      };
      window.jsData = jsData;

      const output = document.querySelector("#output4");
      output.textContent = `Python å¯é€é window.jsData è®€å–ï¼š\n${JSON.stringify(jsData, null, 2)}`;
    };
  </script>
</body>
</html>