<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>01. åŸºç¤åŠŸèƒ½æ¸¬è©¦ï¼ˆæ”¹è‰¯ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- é å…ˆå»ºç«‹é€£ç·šï¼ŒåŠ å¿«è¼‰å…¥ -->
  <link rel="preconnect" href="https://pyscript.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css">
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  
  <style>
    .fallback {
      background: #fff3cd;
      border: 2px solid #ff9800;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }
    .fallback.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-links">
      <a href="index.html">â† å›é¦–é </a>
      <a href="02-compute.html">ä¸‹ä¸€å€‹ â†’</a>
    </div>

    <h1>01. åŸºç¤åŠŸèƒ½æ¸¬è©¦ï¼ˆæ”¹è‰¯ç‰ˆï¼‰</h1>
    <p class="subtitle">åŠ å…¥è¼‰å…¥è¶…æ™‚è™•ç†ã€é‡è©¦æ©Ÿåˆ¶ã€é™ç´šæ–¹æ¡ˆ</p>

    <!-- è¼‰å…¥ç‹€æ…‹ï¼ˆå¢å¼·ç‰ˆï¼‰ -->
    <div class="card">
      <h3>è¼‰å…¥ç‹€æ…‹ç›£æ¸¬</h3>
      <div class="row">
        <span class="status-indicator status-loading" id="status-dot"></span>
        <span id="status-text">PyScript è¼‰å…¥ä¸­...</span>
        <button id="btn-retry" style="display:none; margin-left: auto;">é‡æ–°è¼‰å…¥</button>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="load-progress" style="width: 0%"></div>
      </div>
      <div id="load-detail" style="margin-top: 10px; color: #666; font-size: 0.9em;"></div>
      
      <!-- è¼‰å…¥æ™‚é–“éé•·æç¤º -->
      <div id="slow-warning" class="warning" style="display: none; margin-top: 15px;">
        <strong>â±ï¸ è¼‰å…¥æ™‚é–“è¼ƒé•·</strong>
        <p style="margin-top: 8px;">PyScript é¦–æ¬¡è¼‰å…¥éœ€è¦ä¸‹è¼‰ ~10MB çš„æª”æ¡ˆã€‚å¦‚æœç¶²è·¯è¼ƒæ…¢ï¼Œå¯èƒ½éœ€è¦ 20-60 ç§’ã€‚</p>
        <p style="margin-top: 8px;">å·²è¼‰å…¥æ™‚é–“ï¼š<strong id="elapsed-time">0</strong> ç§’</p>
      </div>
    </div>

    <!-- é™ç´šæ–¹æ¡ˆï¼ˆè¼‰å…¥å¤±æ•—æ™‚é¡¯ç¤ºï¼‰ -->
    <div id="fallback-mode" class="fallback">
      <h3>âš ï¸ PyScript è¼‰å…¥å¤±æ•—</h3>
      <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
      <ul style="margin-left: 20px; margin-top: 10px;">
        <li>ç¶²è·¯é€£ç·šå•é¡Œï¼ˆCDN ç„¡æ³•è¨ªå•ï¼‰</li>
        <li>ç€è¦½å™¨ä¸æ”¯æ´ï¼ˆå»ºè­°ä½¿ç”¨ Chrome/Edge/Firefox æœ€æ–°ç‰ˆï¼‰</li>
        <li>å…§å®¹å®‰å…¨æ”¿ç­–ï¼ˆCSPï¼‰é™åˆ¶</li>
        <li>ç§»å‹•ç¶²è·¯é™åˆ¶ï¼ˆæŸäº›ç¶²è·¯æœƒå°é– CDNï¼‰</li>
      </ul>
      <p style="margin-top: 15px;"><strong>å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
      <ol style="margin-left: 20px;">
        <li>æª¢æŸ¥ç¶²è·¯é€£ç·š</li>
        <li>å˜—è©¦åˆ‡æ›åˆ° Wi-Fi</li>
        <li>ä½¿ç”¨æ¡Œé¢ç€è¦½å™¨</li>
        <li>é»æ“Šä¸Šæ–¹ã€Œé‡æ–°è¼‰å…¥ã€æŒ‰éˆ•</li>
      </ol>
      <div style="margin-top: 20px;">
        <button onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
        <button onclick="testWithoutPyScript()" class="secondary">ä½¿ç”¨ç´” JS æ¨¡å¼ï¼ˆåŠŸèƒ½å—é™ï¼‰</button>
      </div>
    </div>

    <!-- æ¸¬è©¦ 1: DOM æ“ä½œ -->
    <div class="card" id="test1" style="display: none;">
      <h3>æ¸¬è©¦ 1: DOM æ“ä½œ</h3>
      <p>é©—è­‰ Python èƒ½å¦è®€å¯« HTML å…ƒç´ </p>
      <div class="row">
        <input type="text" id="input1" placeholder="è¼¸å…¥ä¸€äº›æ–‡å­—..." value="Hello PyScript">
        <button id="btn-update">æ›´æ–°é¡¯ç¤º</button>
        <button id="btn-clear">æ¸…ç©º</button>
      </div>
      <div class="output-box" id="output1">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <!-- æ¸¬è©¦ 2: äº‹ä»¶è™•ç† -->
    <div class="card" id="test2" style="display: none;">
      <h3>æ¸¬è©¦ 2: äº‹ä»¶è™•ç†</h3>
      <p>æ¸¬è©¦å„ç¨® DOM äº‹ä»¶çš„ç¶å®šèˆ‡éŸ¿æ‡‰</p>
      <div class="row">
        <button id="btn-click">é»æ“Šäº‹ä»¶</button>
        <button id="btn-dblclick">é›™æ“Šäº‹ä»¶</button>
      </div>
      <div class="row">
        <input type="range" id="slider" min="0" max="100" value="50">
        <span id="slider-value">50</span>
      </div>
      <div class="output-box" id="output2">ç­‰å¾…äº‹ä»¶è§¸ç™¼...</div>
    </div>

    <!-- æ¸¬è©¦ 3: Python â†” JS äº’é€š -->
    <div class="card" id="test3" style="display: none;">
      <h3>æ¸¬è©¦ 3: Python â†” JS è³‡æ–™å‚³é</h3>
      <div class="row">
        <button id="btn-py-to-js">Python â†’ JS</button>
        <button id="btn-js-to-py">JS â†’ Python</button>
      </div>
      <div class="output-box" id="output3">ç­‰å¾…è³‡æ–™å‚³é...</div>
    </div>

    <!-- æ•ˆèƒ½çµ±è¨ˆ -->
    <div class="card" id="stats" style="display: none;">
      <h3>æ•ˆèƒ½çµ±è¨ˆ</h3>
      <div class="grid">
        <div class="metric">
          <div class="metric-value" id="event-count">0</div>
          <div class="metric-label">äº‹ä»¶è§¸ç™¼æ¬¡æ•¸</div>
        </div>
        <div class="metric">
          <div class="metric-value" id="load-time">--</div>
          <div class="metric-label">è¼‰å…¥æ™‚é–“ (ç§’)</div>
        </div>
      </div>
    </div>

  </div>

  <!-- PyScript å€åŸŸ -->
  <py-script>
from pyscript import document, window
import time

start_time = time.time()
event_count = 0

def log_event():
    global event_count
    event_count += 1
    document.querySelector("#event-count").innerText = str(event_count)

# æ¸¬è©¦ 1: DOM æ“ä½œ
def update_output(*args):
    log_event()
    input_val = document.querySelector("#input1").value
    output = document.querySelector("#output1")
    output.innerText = f"[{time.strftime('%H:%M:%S')}] ä½ è¼¸å…¥äº†: {input_val}\nå­—å…ƒæ•¸: {len(input_val)}"

def clear_input(*args):
    log_event()
    document.querySelector("#input1").value = ""
    document.querySelector("#output1").innerText = "å·²æ¸…ç©º"

# æ¸¬è©¦ 2: äº‹ä»¶è™•ç†
def handle_click(*args):
    log_event()
    document.querySelector("#output2").innerText = f"[{time.strftime('%H:%M:%S')}] å–®æ“Šäº‹ä»¶è§¸ç™¼ï¼"

def handle_dblclick(*args):
    log_event()
    document.querySelector("#output2").innerText = f"[{time.strftime('%H:%M:%S')}] é›™æ“Šäº‹ä»¶è§¸ç™¼ï¼"

def handle_slider(*args):
    log_event()
    value = document.querySelector("#slider").value
    document.querySelector("#slider-value").innerText = value

# æ¸¬è©¦ 3: è³‡æ–™å‚³é
def py_to_js(*args):
    log_event()
    data = {
        "message": "é€™æ˜¯å¾ Python å‚³ä¾†çš„è³‡æ–™",
        "timestamp": time.time(),
        "list": [1, 2, 3, 4, 5]
    }
    window.pyData = data
    window.displayPyData()

def js_to_py(*args):
    log_event()
    window.sendDataToPython()

# ç¶å®šäº‹ä»¶
document.querySelector("#btn-update").addEventListener("click", update_output)
document.querySelector("#btn-clear").addEventListener("click", clear_input)
document.querySelector("#btn-click").addEventListener("click", handle_click)
document.querySelector("#btn-dblclick").addEventListener("dblclick", handle_dblclick)
document.querySelector("#slider").addEventListener("input", handle_slider)
document.querySelector("#btn-py-to-js").addEventListener("click", py_to_js)
document.querySelector("#btn-js-to-py").addEventListener("click", js_to_py)

# è¼‰å…¥å®Œæˆ
end_time = time.time()
load_time = end_time - start_time

window.pyScriptLoaded(load_time)
print(f"âœ… PyScript è¼‰å…¥å®Œæˆ ({load_time:.2f}s)")
  </py-script>

  <!-- JavaScript è¼‰å…¥ç®¡ç† -->
  <script>
    let loadStartTime = Date.now();
    let loadTimeout = null;
    let slowWarningTimeout = null;
    let elapsedInterval = null;

    // æ¨¡æ“¬é€²åº¦æ¢
    let progress = 0;
    const progressInterval = setInterval(() => {
      if (progress < 85) {
        progress += Math.random() * 3;
        document.getElementById("load-progress").style.width = Math.min(progress, 85) + "%";
        document.getElementById("load-detail").textContent = 
          `æ­£åœ¨ä¸‹è¼‰ PyScript é‹è¡Œç’°å¢ƒ... (${Math.round(progress)}%)`;
      }
    }, 200);

    // è¼‰å…¥è¶…æ™‚æª¢æ¸¬ï¼ˆ30ç§’ï¼‰
    loadTimeout = setTimeout(() => {
      console.error("PyScript è¼‰å…¥è¶…æ™‚");
      handleLoadFailure("è¼‰å…¥è¶…æ™‚ï¼ˆè¶…é 30 ç§’ï¼‰");
    }, 30000);

    // æ…¢é€Ÿè¼‰å…¥è­¦å‘Šï¼ˆ8ç§’å¾Œé¡¯ç¤ºï¼‰
    slowWarningTimeout = setTimeout(() => {
      document.getElementById("slow-warning").style.display = "block";
      
      // é–‹å§‹è¨ˆæ™‚å™¨
      let elapsed = 8;
      elapsedInterval = setInterval(() => {
        elapsed++;
        document.getElementById("elapsed-time").textContent = elapsed;
      }, 1000);
    }, 8000);

    // PyScript è¼‰å…¥æˆåŠŸå›èª¿
    window.pyScriptLoaded = function(loadTime) {
      clearTimeout(loadTimeout);
      clearTimeout(slowWarningTimeout);
      clearInterval(progressInterval);
      if (elapsedInterval) clearInterval(elapsedInterval);

      document.getElementById("load-progress").style.width = "100%";
      document.getElementById("status-dot").className = "status-indicator status-ready";
      document.getElementById("status-text").innerText = "PyScript å·²å°±ç·’";
      document.getElementById("load-detail").textContent = `âœ… è¼‰å…¥æˆåŠŸï¼è€—æ™‚ ${loadTime.toFixed(2)} ç§’`;
      document.getElementById("load-time").innerText = loadTime.toFixed(2);
      
      // éš±è—è­¦å‘Šï¼Œé¡¯ç¤ºæ¸¬è©¦å€
      document.getElementById("slow-warning").style.display = "none";
      document.getElementById("test1").style.display = "block";
      document.getElementById("test2").style.display = "block";
      document.getElementById("test3").style.display = "block";
      document.getElementById("stats").style.display = "block";
    };

    // è¼‰å…¥å¤±æ•—è™•ç†
    function handleLoadFailure(reason) {
      clearInterval(progressInterval);
      if (elapsedInterval) clearInterval(elapsedInterval);

      document.getElementById("status-dot").className = "status-indicator status-error";
      document.getElementById("status-text").innerText = "è¼‰å…¥å¤±æ•—";
      document.getElementById("load-detail").innerHTML = `âŒ ${reason}`;
      document.getElementById("btn-retry").style.display = "inline-block";
      document.getElementById("fallback-mode").classList.add("active");
      
      console.error("PyScript è¼‰å…¥å¤±æ•—:", reason);
    }

    // é‡è©¦æŒ‰éˆ•
    document.getElementById("btn-retry").addEventListener("click", () => {
      location.reload();
    });

    // ç›£è½ PyScript éŒ¯èª¤
    window.addEventListener("error", (e) => {
      if (e.message && e.message.includes("pyscript")) {
        handleLoadFailure("è¼‰å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤");
      }
    });

    // Python å‘¼å«çš„ JS å‡½æ•¸
    window.displayPyData = function() {
      const output = document.querySelector("#output3");
      const data = window.pyData;
      output.innerText = `JS æ”¶åˆ° Python çš„è³‡æ–™ï¼š\n${JSON.stringify(data, null, 2)}`;
    };

    window.sendDataToPython = function() {
      const jsData = {
        message: "é€™æ˜¯å¾ JS å‚³ä¾†çš„è³‡æ–™",
        timestamp: Date.now(),
        userAgent: navigator.userAgent.substring(0, 50) + "..."
      };
      window.jsData = jsData;
      document.querySelector("#output3").innerText = 
        `Python å¯ä»¥é€é window.jsData è®€å–ï¼š\n${JSON.stringify(jsData, null, 2)}`;
    };

    // ç´” JS é™ç´šæ¨¡å¼
    function testWithoutPyScript() {
      alert("ç´” JS æ¨¡å¼ä¸‹ï¼Œéƒ¨åˆ† Python ç‰¹å®šåŠŸèƒ½ç„¡æ³•ä½¿ç”¨ã€‚\né€™å€‹ Demo ä¸»è¦å±•ç¤º PyScriptï¼Œå»ºè­°è§£æ±ºè¼‰å…¥å•é¡Œå¾Œé‡è©¦ã€‚");
      
      // å¯ä»¥åœ¨é€™è£¡å¯¦ä½œä¸€äº›åŸºæœ¬çš„ JS åŠŸèƒ½ä½œç‚ºç¤ºç¯„
      document.getElementById("fallback-mode").innerHTML = `
        <h3>âœ… å·²åˆ‡æ›åˆ°ç´” JS æ¨¡å¼</h3>
        <p>é€™æ˜¯ä¸€å€‹ç°¡åŒ–ç‰ˆæœ¬ï¼Œç”¨æ–¼å±•ç¤ºåŸºæœ¬åŠŸèƒ½ï¼š</p>
        <div style="margin-top: 20px;">
          <input type="text" id="js-input" placeholder="è¼¸å…¥æ–‡å­—" value="Hello JavaScript">
          <button onclick="document.getElementById('js-output').textContent = document.getElementById('js-input').value">
            æ›´æ–°é¡¯ç¤º
          </button>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">
          <strong>è¼¸å‡ºï¼š</strong>
          <div id="js-output">ç­‰å¾…æ“ä½œ...</div>
        </div>
        <p style="margin-top: 20px; color: #666;">
          ğŸ’¡ é€™åªæ˜¯åŸºæœ¬ç¤ºç¯„ã€‚å®Œæ•´åŠŸèƒ½éœ€è¦ PyScript æ­£å¸¸è¼‰å…¥ã€‚
        </p>
      `;
    }
  </script>
</body>
</html>
