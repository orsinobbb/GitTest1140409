<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>åª’é«”ç¤¾ç¾¤é˜²è¡›æˆ°ï¼šå‡è¨Šæ¯æ”»é˜²éŠæˆ²</title>
  <meta name="viewport" content="width=700,user-scalable=no">
  <style>
    body {
      background: #f9fbe7;
      font-family: "Noto Sans TC", Arial, sans-serif;
      text-align: center;
      margin: 0; padding: 0;
      user-select: none;
    }
    h1 { color: #43a047; margin: 18px 0 2px 0; }
    #desc {
      margin: 0 auto 1.2em auto;
      width: 95vw; max-width: 640px;
      color: #263238; font-size: 18px;
      line-height: 1.5;
      border-radius: 9px;
      background: #eafaf1;
      box-shadow: 0 0 4px #a5d6a7a8;
      padding: 0.7em 1.2em 0.9em 1.2em;
    }
    #game-container { margin: 0 auto; }
    canvas {
      background: #fffde7;
      border: 2.5px solid #43a047;
      border-radius: 12px;
      box-shadow: 0 0 24px #aed58155;
      margin-top: 6px;
    }
    #ui-bar {
      margin: 14px auto 2px auto;
      max-width: 650px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
      font-size: 18px;
    }
    #skills { display: flex; gap: 12px; }
    .skill-btn {
      font-size: 17px; padding: 9px 14px;
      border-radius: 8px; border: 2px solid #aed581;
      background: #c8e6c9;
      color: #37474f;
      cursor: pointer;
      transition: background 0.15s;
      min-width: 90px;
      outline: none;
      box-shadow: 0 2px 10px #a5d6a744;
      display: flex; align-items: center; gap: 6px;
      position: relative;
    }
    .skill-btn.selected { background: #fff176; border-color: #fbc02d; }
    .skill-lv {
      position: absolute; right: 7px; bottom: 5px;
      font-size: 13px; color: #7cb342;
      background: #fff; border-radius: 50%; padding: 0 5px;
      border: 1px solid #aed581;
    }
    .upgrade-btn {
      font-size: 15px; padding: 2px 9px;
      background: #fffde7; color: #d84315;
      border: 1.5px solid #ffd54f; border-radius: 7px;
      cursor: pointer; margin-left: 5px;
    }
    #status-bar {
      margin: 0 auto 8px auto;
      font-size: 16px; color: #558b2f;
      max-width: 700px;
      display: flex; justify-content: center; gap: 22px;
      align-items: center;
    }
    #timer-bar {
      width: 220px; height: 16px; background: #e0e0e0;
      border-radius: 7px; margin: 0 8px; position: relative;
      display: inline-block; vertical-align: middle;
    }
    #timer-inner {
      position: absolute; left: 0; top: 0; height: 100%;
      background: linear-gradient(90deg,#7ec850,#fff176);
      border-radius: 7px;
      transition: width 0.12s;
    }
    #result-panel {
      display: none; position: fixed;
      left: 0; right: 0; top: 0; bottom: 0;
      background: #f9fbe7d5;
      justify-content: center; align-items: center; z-index: 10;
    }
    #result-box {
      background: #fff; border: 2px solid #43a047;
      border-radius: 16px; padding: 42px 44px;
      font-size: 23px; color: #d84315;
      box-shadow: 0 2px 40px #7ec85055;
    }
    #result-box button {
      margin-top: 22px; font-size: 20px;
      background: #fff176;
      border: 2px solid #fbc02d; border-radius: 10px;
      padding: 8px 34px; color: #4e342e;
      cursor: pointer;
    }
    @media (max-width:800px) {
      #ui-bar,#status-bar { flex-direction: column; gap: 8px;}
      #game-container { width: 99vw;}
    }
  </style>
</head>
<body>
  <h1>åª’é«”ç¤¾ç¾¤é˜²è¡›æˆ°</h1>
  <div id="desc">
    <b>2025 å°ç£è³‡è¨Šå ´å±æ©Ÿ</b>â€”â€” å‡è¨Šæ¯ã€è¼¿è«–æ”»æ“Šã€æƒ…ç·’ç…½å‹•å››è™•è”“å»¶ã€‚å®ˆè­·åª’é«”ç¤¾ç¾¤æ¯ä¸€é»ç†æ€§ï¼Œè«‹å–„ç”¨å…¬æ°‘æŠ€èƒ½é˜²æ­¢ç´…è‰²æ±¡æŸ“ï¼<br>
    <span style="color:#d84315;">ç¸½æ±¡æŸ“åº¦éé«˜å³éŠæˆ²å¤±æ•—ï¼Œå …æŒä¸‹å»æ‰èƒ½è´å¾—æœ€å¾Œçš„è³‡è¨Šå¥åº·ï¼</span>
  </div>
  <div id="status-bar">
    <span>èƒ½é‡ <b id="energy">50</b></span>
    <span>ç¸½æ±¡æŸ“åº¦ <b id="pollution">0%</b></span>
    <span id="timer-bar"><div id="timer-inner"></div></span>
    <span>å‰©é¤˜ <b id="timeleft">60</b>s</span>
  </div>
  <div id="ui-bar">
    <div id="skills">
      <button class="skill-btn" id="btnCheck"><span>ğŸ”</span>æŸ¥è­‰ <span class="skill-lv" id="lvCheck">1</span></button>
      <button class="skill-btn" id="btnReply"><span>ğŸ’¬</span>ç•™è¨€ <span class="skill-lv" id="lvReply">1</span></button>
      <button class="skill-btn" id="btnReport"><span>ğŸš©</span>èˆ‰å ± <span class="skill-lv" id="lvReport">1</span></button>
      <button class="skill-btn" id="btnAI"><span>ğŸ¤–</span>AI <span class="skill-lv" id="lvAI">1</span></button>
    </div>
    <div>
      <button class="upgrade-btn" id="btnUpgrade">æŠ€èƒ½å‡ç´š</button>
    </div>
  </div>
  <div id="game-container">
    <canvas id="gameCanvas" width="650" height="420"></canvas>
  </div>
  <div id="result-panel">
    <div id="result-box"></div>
  </div>
  <script>
    // === éŠæˆ²åƒæ•¸ ===
    const NODE_COUNT = 14;      // ç¤¾ç¾¤ç¯€é»æ•¸
    const NODE_LINKS = 2;       // æ¯ç¯€é»é„°å±…é€£çµæ•¸
    const GAME_TIME = 60;       // éŠæˆ²æ™‚é•·(s)
    const POLLUTION_FAIL = 55;  // å¤±æ•—é–¾å€¼(%)
    const ENERGY_INIT = 50;     // åˆå§‹èƒ½é‡

    // === æŠ€èƒ½åƒæ•¸èˆ‡å‡ç´šè·¯å¾‘ ===
    const SKILL_PROPS = {
      check:   [{name:"æŸ¥è­‰",   icon:"ğŸ”", cost: 8,  cooldown:1100, effect:28},
                {cost: 7,  cooldown:900,  effect:35},
                {cost: 6,  cooldown:780,  effect:44}],
      reply:   [{name:"ç•™è¨€",   icon:"ğŸ’¬", cost: 10, cooldown:2100, effect:22, range:1},
                {cost: 9,  cooldown:1700, effect:28, range:1.2},
                {cost: 8,  cooldown:1350, effect:38, range:1.3}],
      report:  [{name:"èˆ‰å ±",   icon:"ğŸš©", cost: 14, cooldown:4200, effect:0,  immune:4000},
                {cost: 13, cooldown:3200, effect:0,  immune:6000},
                {cost: 11, cooldown:2600, effect:0,  immune:9000}],
      ai:      [{name:"AI",     icon:"ğŸ¤–", cost: 24, cooldown:6800, effect:0,  auto:3},
                {cost: 22, cooldown:4800, effect:0,  auto:5},
                {cost: 20, cooldown:3400, effect:0,  auto:7}],
    };
    let skillLevel = {check:1, reply:1, report:1, ai:1};
    let skillCD = {check:0, reply:0, report:0, ai:0};
    let selectedSkill = null;
    let energy = ENERGY_INIT;
    let timeLeft = GAME_TIME;
    let pollutionPct = 0;
    let gameRunning = false;

    // === ç¯€é»è³‡æ–™ ===
    let nodes = [];
    let links = [];
    let lastAttack = 0;

    // === ç•«å¸ƒ ===
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // === åˆå§‹åŒ–ç¯€é»èˆ‡é—œè¯ ===
    function resetNodes() {
      nodes = [];
      links = [];
      let cx = 325, cy = 205, R = 165;
      for(let i=0; i<NODE_COUNT; i++){
        let angle = i*2*Math.PI/NODE_COUNT - Math.PI/2 + Math.random()*0.14;
        nodes.push({
          x: cx + R*Math.cos(angle),
          y: cy + R*Math.sin(angle),
          pollution: 7+Math.random()*5,  // åˆå§‹æ±¡æŸ“
          immuneUntil: 0,                // èˆ‰å ±å…ç–«
          id: i,
        });
      }
      // éš¨æ©Ÿé€£çµç¯€é»ä½œç‚ºé„°å±…(ä¾¿æ–¼é€£é–)
      for(let i=0; i<NODE_COUNT; i++){
        let neighbors = [];
        for(let j=1;j<=NODE_LINKS;j++) {
          neighbors.push((i+j)%NODE_COUNT);
        }
        links[i] = neighbors;
      }
    }

    // === æŠ€èƒ½æ“ä½œ ===
    function skillReady(key){
      return skillCD[key]<=0 && energy>=SKILL_PROPS[key][skillLevel[key]-1].cost && gameRunning;
    }
    function setSkillBtnStates(){
      for(let key of ["check","reply","report","ai"]) {
        let btn = document.getElementById("btn"+key[0].toUpperCase()+key.slice(1));
        if(selectedSkill===key) btn.classList.add("selected"); else btn.classList.remove("selected");
        btn.disabled = !skillReady(key);
        document.getElementById("lv"+key[0].toUpperCase()+key.slice(1)).innerText = skillLevel[key];
      }
    }

    // === æŠ€èƒ½è§¸ç™¼ ===
    canvas.onclick = function(e){
      if(!gameRunning || !selectedSkill) return;
      const rect = canvas.getBoundingClientRect();
      let x = (e.clientX-rect.left)/rect.width*canvas.width;
      let y = (e.clientY-rect.top)/rect.height*canvas.height;
      let hit = null;
      for(let n of nodes){
        let d = Math.hypot(n.x-x,n.y-y);
        if(d<28) { hit = n; break; }
      }
      if(!hit) return;
      const now = Date.now();
      const lv = skillLevel[selectedSkill]-1;
      const prop = SKILL_PROPS[selectedSkill][lv];
      if(selectedSkill==="check"){
        if(skillCD.check>0||energy<prop.cost) return;
        n = hit;
        if(n.immuneUntil>now) return;
        n.pollution = Math.max(0, n.pollution-prop.effect);
        energy -= prop.cost;
        skillCD.check = prop.cooldown;
      }
      else if(selectedSkill==="reply"){
        if(skillCD.reply>0||energy<prop.cost) return;
        // æ¶ˆé™¤ä¸­å¿ƒèˆ‡å‘¨åœç¯€é»
        let affected = nodes.filter(m=>Math.hypot(m.x-hit.x,m.y-hit.y)<45*prop.range);
        for(let n of affected){
          if(n.immuneUntil>now) continue;
          n.pollution = Math.max(0, n.pollution-prop.effect);
        }
        energy -= prop.cost;
        skillCD.reply = prop.cooldown;
      }
      else if(selectedSkill==="report"){
        if(skillCD.report>0||energy<prop.cost) return;
        if(hit.immuneUntil>now) return;
        hit.immuneUntil = now+prop.immune;
        energy -= prop.cost;
        skillCD.report = prop.cooldown;
      }
      setSkillBtnStates();
      updateUI();
    };

    document.getElementById("btnCheck").onclick = ()=>{ if(skillReady("check")) selectedSkill="check"; setSkillBtnStates(); };
    document.getElementById("btnReply").onclick = ()=>{ if(skillReady("reply")) selectedSkill="reply"; setSkillBtnStates(); };
    document.getElementById("btnReport").onclick = ()=>{ if(skillReady("report")) selectedSkill="report"; setSkillBtnStates(); };
    document.getElementById("btnAI").onclick = ()=>{
      if(!skillReady("ai")) return;
      const lv = skillLevel.ai-1, prop = SKILL_PROPS.ai[lv];
      // AIè‡ªå‹•æ¶ˆé™¤æ±¡æŸ“
      let dirty = nodes.filter(n=>n.pollution>10 && n.immuneUntil<Date.now());
      for(let i=0;i<Math.min(prop.auto,dirty.length);i++){
        dirty[i].pollution = Math.max(0, dirty[i].pollution-38-4*lv);
      }
      energy -= prop.cost;
      skillCD.ai = prop.cooldown;
      setSkillBtnStates();
      updateUI();
    };

    // === æŠ€èƒ½å‡ç´š ===
    document.getElementById("btnUpgrade").onclick = ()=>{
      let upList = ["check","reply","report","ai"].filter(k=>skillLevel[k]<SKILL_PROPS[k].length);
      if(upList.length==0) return alert("å·²å…¨æ•¸æ»¿ç´šï¼");
      // æœ€ä½ç­‰æŠ€èƒ½å„ªå…ˆ
      let minLv = Math.min(...upList.map(k=>skillLevel[k]));
      let key = upList.find(k=>skillLevel[k]==minLv);
      skillLevel[key]++;
      updateUI();
      setSkillBtnStates();
    };

    // === éŠæˆ²ä¸»å¾ªç’° ===
    function updateGame(dt){
      // æŠ€èƒ½å†·å»å€’æ•¸
      for(let k in skillCD){ if(skillCD[k]>0) skillCD[k]-=dt; if(skillCD[k]<0) skillCD[k]=0;}
      // æ”»æ“Š/æ±¡æŸ“æ“´æ•£
      let now = Date.now();
      if(now-lastAttack>800){
        lastAttack = now;
        let targets = [];
        // å…ˆéš¨æ©Ÿç›´æ¥æ”»æ“Šä¸€å€‹ç¯€é»
        for(let n of nodes){
          if(Math.random()<0.10 && n.immuneUntil<now){
            n.pollution += 9+Math.random()*5;
            targets.push(n);
          }
        }
        // æ“´æ•£æ©Ÿæœƒ
        for(let n of nodes){
          if(n.pollution>55 && Math.random()<0.23 && n.immuneUntil<now){
            for(let idx of links[n.id]){
              let neighbor = nodes[idx];
              if(neighbor.immuneUntil<now) neighbor.pollution += 4+Math.random()*4;
            }
          }
        }
        // æ±¡æŸ“ä¸Šé™
        for(let n of nodes) n.pollution = Math.min(100, n.pollution);
      }
      // æ±¡æŸ“ç¸½é‡è¨ˆç®—
      let total = nodes.reduce((s,n)=>s+n.pollution,0);
      pollutionPct = Math.round(total/(nodes.length*100)*100);
      if(pollutionPct>=POLLUTION_FAIL) endGame(false);
    }

    // === ç•«é¢æ›´æ–° ===
    function drawGame(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // ç•«é€£çµ
      ctx.save();
      ctx.strokeStyle = "#bdbdbd";
      ctx.lineWidth = 5;
      ctx.globalAlpha = 0.28;
      for(let i=0; i<nodes.length; i++){
        let n = nodes[i];
        for(let idx of links[n.id]){
          let n2 = nodes[idx];
          ctx.beginPath();
          ctx.moveTo(n.x,n.y);
          ctx.lineTo(n2.x,n2.y);
          ctx.stroke();
        }
      }
      ctx.restore();
      // ç•«ç¯€é»
      for(let n of nodes){
        let cval = Math.round(n.pollution);
        let r = Math.min(65,cval*2.1), g = Math.max(80, 255-cval*1.6), b = Math.max(70,180-cval);
        ctx.save();
        // æ±¡æŸ“ç‹€æ…‹é¡è‰²
        ctx.beginPath();
        ctx.arc(n.x,n.y,23,0,2*Math.PI);
        ctx.fillStyle = `rgb(${r},${g},${b})`;
        ctx.shadowColor = "#d84315"; ctx.shadowBlur = n.pollution>55?14:0;
        ctx.fill();
        ctx.restore();
        // é‚Šæ¡†
        ctx.beginPath();
        ctx.arc(n.x,n.y,23,0,2*Math.PI);
        ctx.lineWidth = 2.5;
        ctx.strokeStyle = n.immuneUntil>Date.now() ? "#81d4fa" : "#263238";
        ctx.stroke();
        // æ±¡æŸ“åº¦é¡¯ç¤º
        ctx.font = "14px Arial"; ctx.fillStyle="#263238"; ctx.textAlign="center";
        ctx.fillText(Math.round(n.pollution),n.x,n.y+4);
      }
    }

    function updateUI(){
      document.getElementById("energy").innerText = Math.max(0,Math.round(energy));
      document.getElementById("pollution").innerText = pollutionPct+"%";
      setSkillBtnStates();
    }

    // === éŠæˆ²ä¸»å›åœˆ ===
    let prevTS = null;
    function mainLoop(ts){
      if(!gameRunning) return;
      if(!prevTS) prevTS=ts;
      let dt = ts-prevTS; prevTS=ts;
      updateGame(dt);
      drawGame();
      updateUI();
      // æ™‚é–“
      timeLeft -= dt/1000;
      if(timeLeft<=0) endGame(true);
      document.getElementById("timeleft").innerText = Math.max(0,Math.ceil(timeLeft));
      let timerW = Math.max(0,Math.round(220*timeLeft/GAME_TIME));
      document.getElementById("timer-inner").style.width = timerW+"px";
      if(gameRunning) requestAnimationFrame(mainLoop);
    }

    // === éŠæˆ²çµæŸ ===
    function endGame(win){
      gameRunning = false;
      document.getElementById("result-panel").style.display = "flex";
      document.getElementById("result-box").innerHTML = win ?
        `<div>ğŸ‰ ä½ æˆåŠŸå®ˆä½äº†è³‡è¨Šè¼¿è«–å ´ï¼<br><b style="color:#43a047;">è³‡è¨Šå¥åº·é”æ¨™</b>ï¼Œå°ç£æ›´å®‰å…¨ï¼<br><br>
         <button onclick="restartGame()">å†ç©ä¸€æ¬¡</button></div>` :
        `<div>ğŸ’¥ è³‡è¨Šæ±¡æŸ“éé«˜ï¼<br><b style="color:#d84315;">å°ç£ç¤¾ç¾¤å·²é™·å…¥å‡è¨Šæ¯é¢¨æš´â€¦</b><br><br>
         <button onclick="restartGame()">å†ä¾†ä¸€æ¬¡</button></div>`;
    }
    window.restartGame = function(){
      document.getElementById("result-panel").style.display = "none";
      startGame();
    };

    // === éŠæˆ²åˆå§‹åŒ– ===
    function startGame(){
      skillLevel = {check:1, reply:1, report:1, ai:1};
      skillCD = {check:0, reply:0, report:0, ai:0};
      selectedSkill = null;
      energy = ENERGY_INIT;
      timeLeft = GAME_TIME;
      pollutionPct = 0;
      gameRunning = true;
      prevTS = null;
      resetNodes();
      setSkillBtnStates();
      updateUI();
      requestAnimationFrame(mainLoop);
    }

    // === é–‹å§‹éŠæˆ² ===
    window.onload = function(){
      startGame();
    }
  </script>
</body>
</html>
